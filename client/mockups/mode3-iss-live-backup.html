<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mission Control - Mode 3: ISS Tracker (Live)</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Three.js -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0a1628;
      --bg-panel: #0d1a2d;
      --border-color: #1a3a5c;
      --text-primary: #ffffff;
      --text-secondary: #8b949e;
      --text-accent: #00d4ff;
      --success-color: #7ed321;
      --iss-color: #00bcd4;
      --danger-color: #ff3b30;
    }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }
    .mission-control {
      display: grid;
      grid-template-rows: auto 1fr auto auto;
      height: 100vh;
    }
    
    /* Header */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 24px;
      background: linear-gradient(180deg, #0d1a2d 0%, #0a1628 100%);
      border-bottom: 1px solid var(--border-color);
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .agency-logos { display: flex; gap: 6px; }
    .agency-logo {
      width: 32px; height: 32px; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      font-size: 8px; font-weight: bold;
    }
    .mission-info h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: 3px; }
    .mission-subtitle { font-size: 0.75rem; color: var(--iss-color); letter-spacing: 1px; }
    .header-center { display: flex; align-items: center; gap: 24px; }
    .orbit-badge {
      background: rgba(0, 188, 212, 0.2);
      border: 1px solid var(--iss-color);
      padding: 6px 14px; border-radius: 4px;
      font-size: 0.7rem; font-weight: 600;
      color: var(--iss-color); letter-spacing: 1px;
    }
    .current-time { font-family: 'Courier New', monospace; font-size: 0.9rem; color: var(--text-secondary); }
    
    /* Main Content */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      padding: 12px 16px;
      min-height: 0;
      gap: 12px;
    }
    
    /* Map Container */
    .map-container {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(0, 188, 212, 0.1);
      border-bottom: 1px solid var(--border-color);
    }
    .map-title { font-size: 0.75rem; font-weight: 600; letter-spacing: 1px; color: var(--iss-color); }
    .map-controls { display: flex; gap: 8px; }
    .map-btn {
      background: rgba(0, 188, 212, 0.2);
      border: 1px solid var(--iss-color);
      color: var(--iss-color);
      padding: 4px 10px;
      font-size: 0.65rem;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .map-btn:hover { background: rgba(0, 188, 212, 0.3); }
    .map-btn.active { background: var(--iss-color); color: #000; }
    
    #iss-map { flex: 1; min-height: 300px; background: #0a1628; }
    
    /* Data Overlay */
    .data-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(10, 22, 40, 0.95);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 12px;
      z-index: 1000;
      min-width: 180px;
    }
    .data-row { display: flex; gap: 16px; margin-bottom: 6px; }
    .data-row:last-child { margin-bottom: 0; }
    .data-item label { 
      font-size: 0.5rem; 
      color: var(--text-secondary); 
      letter-spacing: 1px; 
      display: block; 
      text-transform: uppercase;
    }
    .data-item span { 
      font-family: 'Courier New', monospace; 
      font-size: 0.9rem; 
      color: var(--text-primary);
    }
    
    /* Side Panel - ISS Telemetry */
    .side-panel {
      display: flex; 
      flex-direction: column;
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }
    
    /* Model Loading Indicator */
    .model-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--border-color);
      border-top-color: var(--text-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }
    .loading-progress {
      font-family: 'Courier New', monospace;
      font-size: 1.2rem;
      color: var(--text-accent);
    }
    .model-loading.hidden { display: none; }
    
    .iss-telemetry-panel {
      display: flex;
      flex-direction: column;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: rgba(0, 188, 212, 0.1);
      border-bottom: 1px solid var(--border-color);
    }
    .panel-title {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--text-accent);
    }
    
    /* Station Viewer - 3 column layout */
    .station-viewer {
      flex: 1;
      display: flex;
      min-height: 0;
      background: #000;
    }
    
    /* Module columns - wider to show inline telemetry */
    .module-column {
      width: 150px;
      background: rgba(13, 26, 45, 0.95);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 4px;
    }
    .module-column-right {
      border-right: none;
      border-left: 1px solid var(--border-color);
    }
    .column-header {
      font-size: 0.5rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--text-secondary);
      text-align: center;
      padding: 6px 4px;
      background: rgba(0, 0, 0, 0.4);
      border-bottom: 1px solid var(--border-color);
      margin: -4px -4px 4px -4px;
    }
    
    /* Module cards - horizontal layout with inline telemetry */
    .module-card {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      padding: 4px;
      border: 1px solid rgba(26, 58, 92, 0.4);
      border-radius: 4px;
      margin-bottom: 3px;
      background: rgba(0, 15, 30, 0.6);
      transition: all 0.2s ease;
    }
    .module-card:hover {
      background: rgba(0, 212, 255, 0.08);
      border-color: rgba(0, 212, 255, 0.4);
    }
    
    /* Icon section - left side for left column, right side for right column */
    .module-icon-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 40px;
      min-width: 40px;
      padding: 2px;
    }
    .module-column-left .module-icon-wrap {
      border-right: 1px solid rgba(26, 58, 92, 0.5);
      margin-right: 6px;
    }
    .module-column-right .module-icon-wrap {
      border-left: 1px solid rgba(26, 58, 92, 0.5);
      margin-left: 6px;
      order: 2;
    }
    .module-icon {
      width: 32px;
      height: 18px;
      color: var(--text-secondary);
    }
    .module-label {
      font-size: 0.4rem;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1;
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    /* Telemetry section - always visible inline */
    .module-telem {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      font-size: 0.45rem;
    }
    .module-column-right .module-telem {
      order: 1;
      text-align: right;
    }
    .telem-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1px 0;
    }
    .module-column-right .telem-row {
      flex-direction: row-reverse;
    }
    .telem-lbl {
      color: #5a7a9a;
      font-size: 0.38rem;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }
    .telem-val {
      font-family: 'Courier New', monospace;
      font-size: 0.48rem;
      color: var(--text-accent);
      font-weight: 600;
    }
    .telem-val.nominal { color: var(--success-color); }
    .telem-val.warn { color: #ffaa00; }
    .telem-val.crit { color: var(--danger-color); }
      border: 1px solid var(--text-accent);
      border-radius: 4px;
      min-width: 130px;
      z-index: 200;
      box-shadow: 0 2px 12px rgba(0, 212, 255, 0.4);
      display: none;
    }
    .module-column-left .module-popup-inline {
      left: 100%;
      margin-left: 2px;
    }
    .module-column-right .module-popup-inline {
      right: 100%;
      margin-right: 2px;
    }
    .module-card.active .module-popup-inline {
      display: block;
    }
    .popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px;
      background: rgba(0, 212, 255, 0.2);
      border-bottom: 1px solid var(--border-color);
      border-radius: 3px 3px 0 0;
    }
    .popup-name {
      font-size: 0.5rem;
      font-weight: 600;
      color: var(--text-accent);
      letter-spacing: 0.5px;
    }
    .popup-tag {
      font-size: 0.4rem;
      color: var(--text-secondary);
      background: rgba(0,0,0,0.3);
      padding: 1px 4px;
      border-radius: 2px;
    }
    .popup-content {
      padding: 4px 6px;
    }
    .popup-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
      border-bottom: 1px solid rgba(26, 58, 92, 0.3);
    }
    .popup-row:last-child {
      border-bottom: none;
    }
    .popup-label {
      font-size: 0.4rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .popup-value {
      font-family: 'Courier New', monospace;
      font-size: 0.5rem;
      font-weight: 600;
    }
    .popup-value.nominal { color: var(--success-color); }
    .popup-value.warning { color: #ffaa00; }
    .popup-value.critical { color: var(--danger-color); }
    }
    .module-telemetry-tag {
      font-size: 0.6rem;
      font-family: 'Courier New', monospace;
      color: var(--text-accent);
      background: rgba(0, 212, 255, 0.2);
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 8px;
    }
    .close-telemetry {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
    }
    .close-telemetry:hover {
      color: #ff6b6b;
    }
    .module-telemetry-content {
      padding: 10px 12px;
    }
    .telemetry-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid rgba(26, 58, 92, 0.5);
    }
    .telemetry-row:last-child {
      border-bottom: none;
    }
    .telemetry-label {
      font-size: 0.6rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .telemetry-value {
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      color: var(--text-primary);
    }
    .telemetry-value.nominal {
      color: #4ade80;
    }
    .telemetry-value.warning {
      color: #fbbf24;
    }
    .telemetry-value.critical {
      color: #ef4444;
    }
    
    /* 3D Viewer Styles */
    .iss-3d-wrapper {
      flex: 1;
      position: relative;
      background: #000;
      min-height: 0;
    }
    #iss3dCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    
    /* Telemetry Overlay on 3D Model */
    .telemetry-overlay {
      position: absolute;
      bottom: 12px;
      left: 12px;
      right: 12px;
      pointer-events: none;
    }
    .attitude-display {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .attitude-item {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 6px 12px;
      text-align: center;
      min-width: 70px;
    }
    .att-label {
      display: block;
      font-size: 0.5rem;
      color: var(--text-secondary);
      letter-spacing: 1px;
    }
    .att-value {
      display: block;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-accent);
    }
    
    /* Module Popup */
    .module-popup {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 180px;
      background: rgba(13, 26, 45, 0.95);
      border: 1px solid var(--text-accent);
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    }
    .module-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: rgba(0, 188, 212, 0.2);
      border-bottom: 1px solid var(--border-color);
    }
    .module-name {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .module-tag {
      font-size: 0.5rem;
      background: rgba(0, 212, 255, 0.2);
      color: var(--text-accent);
      padding: 2px 5px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    .module-popup-content {
      padding: 8px 10px;
    }
    .popup-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      font-size: 0.65rem;
    }
    .popup-label { color: var(--text-secondary); }
    .popup-value { 
      font-family: 'Courier New', monospace;
      color: var(--text-primary);
    }
    .popup-value.nominal { color: var(--success-color); }
    .panel-section { border-bottom: 1px solid var(--border-color); }
    .panel-section:last-child { border-bottom: none; flex: 1; }
    .section-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      padding: 10px 12px;
      background: rgba(0, 188, 212, 0.1);
    }
    .section-title { 
      font-size: 0.7rem; 
      font-weight: 600; 
      letter-spacing: 1px; 
      color: var(--text-accent); 
    }
    .live-badge { 
      display: flex; 
      align-items: center; 
      gap: 4px; 
      font-size: 0.6rem; 
      color: var(--danger-color); 
    }
    .live-dot { 
      width: 6px; 
      height: 6px; 
      background: var(--danger-color); 
      border-radius: 50%; 
      animation: pulse 1s infinite; 
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
    .section-content { padding: 10px 12px; }
    
    .video-embed { 
      background: #000; 
      height: 120px; 
      border-radius: 4px; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .video-embed iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .video-placeholder { 
      color: var(--text-secondary); 
      font-size: 0.7rem; 
      text-align: center;
    }
    
    /* ISS Diagram Panel Styles */
    .iss-diagram-section { flex: 1; min-height: 0; }
    .iss-diagram-container {
      position: relative;
      background: #000;
      border-radius: 4px;
      overflow: hidden;
      padding: 0;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .iss-diagram-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      opacity: 0.95;
    }
    .module-hotspots {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .hotspot {
      position: absolute;
      width: 12px;
      height: 12px;
      background: rgba(0, 212, 255, 0.8);
      border: 2px solid #00d4ff;
      border-radius: 50%;
      cursor: pointer;
      pointer-events: auto;
      transform: translate(-50%, -50%);
      transition: all 0.2s;
    }
    .hotspot:hover {
      background: #00d4ff;
      transform: translate(-50%, -50%) scale(1.3);
      box-shadow: 0 0 15px rgba(0, 212, 255, 0.8);
    }
    .hotspot.russian {
      background: rgba(255, 100, 100, 0.8);
      border-color: #ff6464;
    }
    .hotspot.russian:hover {
      background: #ff6464;
      box-shadow: 0 0 15px rgba(255, 100, 100, 0.8);
    }
    .hotspot-pulse {
      position: absolute;
      inset: -4px;
      border: 1px solid currentColor;
      border-radius: 50%;
      animation: hotspot-pulse 2s infinite;
      opacity: 0;
    }
    @keyframes hotspot-pulse {
      0% { transform: scale(1); opacity: 0.6; }
      100% { transform: scale(2); opacity: 0; }
    }
    
    /* Module Telemetry Section */
    .module-telemetry-section { flex: 1; }
    .module-tag {
      font-size: 0.55rem;
      background: rgba(0, 212, 255, 0.2);
      color: var(--text-accent);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    .module-telemetry-grid {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .telemetry-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 3px;
      border-left: 2px solid var(--border-color);
    }
    .tel-label {
      font-size: 0.65rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .tel-value {
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    .tel-status-ok { color: var(--success-color); }
    .tel-status-warn { color: #ffd60a; }
    .tel-status-error { color: var(--danger-color); }
    
    /* Quick Stats */
    .quick-stats-section {
      flex: 0 0 auto;
      background: rgba(0, 188, 212, 0.05);
    }
    .quick-stats-section .section-content { padding: 8px 12px; }
    .quick-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .quick-stat {
      text-align: center;
      padding: 6px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    .quick-stat-value {
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-accent);
    }
    .quick-stat-label {
      font-size: 0.5rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }
    
    .telemetry-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .telemetry-item { 
      background: rgba(0,0,0,0.3); 
      padding: 8px; 
      border-radius: 4px; 
      text-align: center; 
    }
    .telemetry-value { 
      font-family: 'Courier New', monospace; 
      font-size: 0.9rem; 
      font-weight: 700; 
    }
    .telemetry-label { 
      font-size: 0.5rem; 
      color: var(--text-secondary); 
      letter-spacing: 1px; 
      margin-top: 2px; 
    }
    
    .crew-list { 
      display: flex; 
      flex-direction: column; 
      gap: 3px; 
      max-height: 120px; 
      overflow-y: auto; 
    }
    .crew-member {
      display: flex; 
      align-items: center; 
      gap: 6px;
      background: rgba(126, 211, 33, 0.1);
      border: 1px solid var(--success-color);
      padding: 3px 6px; 
      border-radius: 3px; 
      font-size: 0.6rem;
    }
    .crew-dot { 
      width: 4px; 
      height: 4px; 
      background: var(--success-color); 
      border-radius: 50%; 
    }
    .crew-agency { 
      margin-left: auto; 
      color: var(--text-secondary); 
      font-size: 0.5rem; 
    }
    
    /* Timeline */
    .timeline-bar {
      background: var(--bg-panel);
      border-top: 1px solid var(--border-color);
      padding: 10px 16px;
      display: flex; 
      justify-content: space-between; 
      align-items: center;
    }
    .next-pass label { 
      font-size: 0.6rem; 
      color: var(--text-secondary); 
      letter-spacing: 1px; 
    }
    .next-pass .time { 
      font-family: 'Courier New', monospace; 
      font-size: 1rem; 
      color: var(--iss-color); 
    }
    .next-pass .location { font-size: 0.7rem; }
    .orbit-stats { display: flex; gap: 24px; }
    .stat-item { text-align: center; }
    .stat-value { 
      font-family: 'Courier New', monospace; 
      font-size: 0.95rem; 
    }
    .stat-label { 
      font-size: 0.55rem; 
      color: var(--text-secondary); 
    }
    
    /* News Ticker */
    .news-ticker {
      background: var(--bg-panel);
      border-top: 1px solid var(--border-color);
      padding: 6px 0; 
      overflow: hidden;
    }
    .ticker-content { 
      display: flex; 
      animation: scroll 40s linear infinite; 
    }
    @keyframes scroll { 
      0%{transform:translateX(0)} 
      100%{transform:translateX(-50%)} 
    }
    .ticker-label { 
      background: var(--iss-color); 
      color: #000; 
      padding: 2px 8px; 
      font-size: 0.55rem; 
      font-weight: 700; 
      margin-right: 10px; 
      flex-shrink: 0; 
    }
    .ticker-item { 
      white-space: nowrap; 
      margin-right: 30px; 
      font-size: 0.7rem; 
    }
    .ticker-time { 
      color: var(--text-secondary); 
      margin-right: 6px; 
    }

    /* Leaflet customizations */
    .leaflet-container {
      background: #0a1628 !important;
    }
    .leaflet-control-attribution {
      background: rgba(13, 26, 45, 0.8) !important;
      color: #8b949e !important;
      font-size: 10px !important;
    }
    .leaflet-control-attribution a {
      color: #00bcd4 !important;
    }
    .leaflet-control-zoom a {
      background: #0d1a2d !important;
      color: #00bcd4 !important;
      border-color: #1a3a5c !important;
    }
    .leaflet-control-zoom a:hover {
      background: #1a3a5c !important;
    }
    
    /* ISS Marker Animation */
    .iss-marker {
      background: transparent !important;
      border: none !important;
    }
    .iss-icon {
      filter: drop-shadow(0 0 10px #00bcd4);
      animation: iss-pulse 2s ease-in-out infinite;
    }
    @keyframes iss-pulse {
      0%, 100% { filter: drop-shadow(0 0 10px #00bcd4); }
      50% { filter: drop-shadow(0 0 20px #ffd60a); }
    }
    
    /* Live update flash animation */
    .live-update {
      animation: flash-update 0.5s ease-out;
    }
    @keyframes flash-update {
      0% { color: #7ed321; text-shadow: 0 0 10px #7ed321; }
      100% { color: inherit; text-shadow: none; }
    }
    
    /* Connection status dots */
    .connecting-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      background: #ffd60a;
      border-radius: 50%;
      margin-right: 4px;
      animation: blink 1s infinite;
    }
    .offline-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      background: #ff3b30;
      border-radius: 50%;
      margin-right: 4px;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .leaflet-popup-content-wrapper {
      background: #0d1a2d !important;
      border: 1px solid #00bcd4 !important;
      border-radius: 4px !important;
      color: #fff !important;
    }
    .leaflet-popup-tip {
      background: #0d1a2d !important;
    }
    .leaflet-popup-content {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      margin: 10px;
    }
  </style>
</head>
<body>
  <div class="mission-control">
    <header class="header-bar">
      <div class="header-left">
        <div class="agency-logos">
          <div class="agency-logo" style="background:#0b3d91;color:#fff">NASA</div>
          <div class="agency-logo" style="background:#003399;color:#fff">ESA</div>
          <div class="agency-logo" style="background:#c41e3a;color:#fff">JAXA</div>
          <div class="agency-logo" style="background:#1e88e5;color:#fff">CSA</div>
          <div class="agency-logo" style="background:#0033a0;color:#fff">RSA</div>
        </div>
        <div class="mission-info">
          <h1>ISS EXPEDITION 72</h1>
          <div class="mission-subtitle">International Space Station ¬∑ Low Earth Orbit</div>
        </div>
      </div>
      <div class="header-center">
        <div class="orbit-badge" id="orbitBadge">üõ∞Ô∏è ORBIT ---</div>
      </div>
      <div class="header-right">
        <div class="current-time" id="utc">--:--:-- UTC</div>
      </div>
    </header>

    <main class="main-content">
      <div class="map-container" style="position: relative;">
        <div class="map-header">
          <span class="map-title">üåç REAL-TIME ISS TRACKER</span>
          <div class="map-controls">
            <button class="map-btn" id="btnFootprint" onclick="toggleFootprint()">Footprint</button>
            <button class="map-btn" id="btnTrack" onclick="toggleTrack()">Track</button>
            <button class="map-btn" onclick="centerOnISS()">Center ISS</button>
          </div>
        </div>
        <div id="iss-map"></div>
        
        <div class="data-overlay">
          <div class="data-row">
            <div class="data-item">
              <label>Latitude</label>
              <span id="dataLat">--¬∞</span>
            </div>
            <div class="data-item">
              <label>Longitude</label>
              <span id="dataLng">--¬∞</span>
            </div>
          </div>
          <div class="data-row">
            <div class="data-item">
              <label>Altitude</label>
              <span id="dataAlt">-- km</span>
            </div>
            <div class="data-item">
              <label>Velocity</label>
              <span id="dataVel">-- km/h</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="side-panel iss-telemetry-panel">
        <div class="panel-header">
          <span class="panel-title">üõ∞Ô∏è STATION SYSTEMS</span>
          <div class="live-badge" id="nasaLiveBadge"><span class="connecting-dot"></span>NASA LIVE</div>
        </div>
        
        <div class="station-viewer">
          <!-- Left module column - US Segment -->
          <div class="module-column module-column-left">
            <div class="column-header">US SEGMENT</div>
            <div class="module-card" data-module="destiny">
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 60 24">
                  <rect x="2" y="4" width="56" height="16" rx="3" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <line x1="15" y1="4" x2="15" y2="20" stroke="currentColor" stroke-width="1" opacity="0.5"/>
                  <line x1="30" y1="4" x2="30" y2="20" stroke="currentColor" stroke-width="1" opacity="0.5"/>
                  <line x1="45" y1="4" x2="45" y2="20" stroke="currentColor" stroke-width="1" opacity="0.5"/>
                </svg>
                <span class="module-label">Destiny</span>
              </div>
              <div class="module-telem" id="telem-destiny">
                <div class="telem-row"><span class="telem-lbl">Temp</span><span class="telem-val nominal" id="destiny-temp">--¬∞C</span></div>
                <div class="telem-row"><span class="telem-lbl">O‚ÇÇ</span><span class="telem-val nominal" id="destiny-o2">-- mmHg</span></div>
                <div class="telem-row"><span class="telem-lbl">CO‚ÇÇ</span><span class="telem-val nominal" id="destiny-co2">-- mmHg</span></div>
              </div>
            </div>
            <div class="module-card" data-module="harmony">
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 40 24">
                  <rect x="8" y="4" width="24" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <rect x="0" y="8" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1"/>
                  <rect x="32" y="8" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Harmony</span>
              </div>
              <div class="module-telem" id="telem-harmony">
                <div class="telem-row"><span class="telem-lbl">Press</span><span class="telem-val nominal" id="harmony-press">-- psia</span></div>
                <div class="telem-row"><span class="telem-lbl">Temp</span><span class="telem-val nominal" id="harmony-temp">--¬∞C</span></div>
              </div>
            </div>
            <div class="module-card" data-module="tranquility">
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 40 28">
                  <rect x="8" y="2" width="24" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <circle cx="20" cy="24" r="5" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Tranq</span>
              </div>
              <div class="module-telem" id="telem-tranquility">
                <div class="telem-row"><span class="telem-lbl">Press</span><span class="telem-val nominal" id="tranq-press">-- psia</span></div>
                <div class="telem-row"><span class="telem-lbl">Temp</span><span class="telem-val nominal" id="tranq-temp">--¬∞C</span></div>
              </div>
            </div>
            <div class="module-card" data-module="unity">
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 40 24">
                  <rect x="8" y="4" width="24" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <rect x="0" y="8" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1"/>
                  <rect x="32" y="8" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Unity</span>
              </div>
              <div class="module-telem" id="telem-unity">
                <div class="telem-row"><span class="telem-lbl">Press</span><span class="telem-val nominal" id="unity-press">-- psia</span></div>
                <div class="telem-row"><span class="telem-lbl">Temp</span><span class="telem-val nominal" id="unity-temp">--¬∞C</span></div>
              </div>
            </div>
            <div class="module-card" data-module="quest">
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 24 28">
                  <rect x="2" y="2" width="20" height="24" rx="3" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <circle cx="12" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Quest</span>
              </div>
              <div class="module-telem" id="telem-quest">
                <div class="telem-row"><span class="telem-lbl">Press</span><span class="telem-val nominal" id="quest-press">-- psia</span></div>
                <div class="telem-row"><span class="telem-lbl">EVA</span><span class="telem-val nominal">STBY</span></div>
              </div>
            </div>
            <div class="module-card" data-module="cupola">
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 30 22">
                  <path d="M5 18 Q5 4 15 4 Q25 4 25 18" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <line x1="5" y1="18" x2="25" y2="18" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                <span class="module-label">Cupola</span>
              </div>
              <div class="module-telem" id="telem-cupola">
                <div class="telem-row"><span class="telem-lbl">Shutter</span><span class="telem-val nominal">OPEN</span></div>
                <div class="telem-row"><span class="telem-lbl">View</span><span class="telem-val nominal">EARTH</span></div>
              </div>
            </div>
          </div>
          
          <!-- Center 3D viewer -->
          <div class="iss-3d-wrapper">
            <canvas id="iss3dCanvas"></canvas>
            <div class="model-loading" id="modelLoading">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading ISS Model...</div>
              <div class="loading-progress" id="loadingProgress">0%</div>
            </div>
            <div class="telemetry-overlay" id="telemetryOverlay">
              <div class="attitude-display">
                <div class="attitude-item">
                  <span class="att-label">ROLL</span>
                  <span class="att-value" id="attRoll">--¬∞</span>
                </div>
                <div class="attitude-item">
                  <span class="att-label">PITCH</span>
                  <span class="att-value" id="attPitch">--¬∞</span>
                </div>
                <div class="attitude-item">
                  <span class="att-label">YAW</span>
                  <span class="att-value" id="attYaw">--¬∞</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right module column - International/Russian -->
          <div class="module-column module-column-right">
            <div class="column-header">INTL / RUS</div>
            <div class="module-card" data-module="columbus">
              <div class="module-telem" id="telem-columbus">
                <div class="telem-row"><span class="telem-val nominal" id="columbus-press">-- psia</span><span class="telem-lbl">Press</span></div>
                <div class="telem-row"><span class="telem-val nominal" id="columbus-temp">--¬∞C</span><span class="telem-lbl">Temp</span></div>
              </div>
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 50 24">
                  <rect x="2" y="4" width="46" height="16" rx="3" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="1"/>
                  <circle cx="25" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="1"/>
                  <circle cx="38" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Columbus</span>
              </div>
            </div>
            <div class="module-card" data-module="kibo">
              <div class="module-telem" id="telem-kibo">
                <div class="telem-row"><span class="telem-val nominal" id="kibo-press">-- psia</span><span class="telem-lbl">Press</span></div>
                <div class="telem-row"><span class="telem-val nominal" id="kibo-temp">--¬∞C</span><span class="telem-lbl">Temp</span></div>
              </div>
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 50 24">
                  <rect x="2" y="4" width="32" height="16" rx="3" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <rect x="34" y="7" width="14" height="10" rx="2" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Kibo</span>
              </div>
            </div>
            <div class="module-card" data-module="zvezda">
              <div class="module-telem" id="telem-zvezda">
                <div class="telem-row"><span class="telem-val nominal" id="zvezda-press">-- psia</span><span class="telem-lbl">Press</span></div>
                <div class="telem-row"><span class="telem-val nominal" id="zvezda-temp">--¬∞C</span><span class="telem-lbl">Temp</span></div>
              </div>
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 50 24">
                  <rect x="2" y="4" width="46" height="16" rx="3" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <circle cx="42" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Zvezda</span>
              </div>
            </div>
            <div class="module-card" data-module="zarya">
              <div class="module-telem" id="telem-zarya">
                <div class="telem-row"><span class="telem-val nominal" id="zarya-press">-- psia</span><span class="telem-lbl">Press</span></div>
                <div class="telem-row"><span class="telem-val nominal">OK</span><span class="telem-lbl">Power</span></div>
              </div>
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 50 24">
                  <rect x="2" y="4" width="46" height="16" rx="3" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <rect x="10" y="0" width="6" height="4" fill="none" stroke="currentColor" stroke-width="1"/>
                  <rect x="34" y="0" width="6" height="4" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Zarya</span>
              </div>
            </div>
            <div class="module-card" data-module="nauka">
              <div class="module-telem" id="telem-nauka">
                <div class="telem-row"><span class="telem-val nominal" id="nauka-press">-- psia</span><span class="telem-lbl">Press</span></div>
                <div class="telem-row"><span class="telem-val nominal">OK</span><span class="telem-lbl">Status</span></div>
              </div>
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 50 24">
                  <rect x="2" y="4" width="46" height="16" rx="3" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <rect x="18" y="0" width="8" height="4" rx="1" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Nauka</span>
              </div>
            </div>
            <div class="module-card" data-module="solar">
              <div class="module-telem" id="telem-solar">
                <div class="telem-row"><span class="telem-val nominal" id="solar-angle">--¬∞</span><span class="telem-lbl">Angle</span></div>
                <div class="telem-row"><span class="telem-val nominal">~30kW</span><span class="telem-lbl">Power</span></div>
              </div>
              <div class="module-icon-wrap">
                <svg class="module-icon" viewBox="0 0 50 20">
                  <rect x="20" y="6" width="10" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <rect x="0" y="2" width="20" height="16" fill="none" stroke="currentColor" stroke-width="1"/>
                  <rect x="30" y="2" width="20" height="16" fill="none" stroke="currentColor" stroke-width="1"/>
                </svg>
                <span class="module-label">Solar</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <div class="timeline-bar">
      <div class="next-pass">
        <label>CURRENT POSITION OVER</label>
        <div class="time" id="overLocation">--</div>
        <div class="location" id="overCountry">Calculating...</div>
      </div>
      <div class="orbit-stats">
        <div class="stat-item">
          <div class="stat-value">16</div>
          <div class="stat-label">Orbits/Day</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statVel">--</div>
          <div class="stat-label">km/h</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statOrbit">---</div>
          <div class="stat-label">Total Orbits</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">25 yrs</div>
          <div class="stat-label">In Orbit</div>
        </div>
      </div>
    </div>
    
    <div class="news-ticker">
      <div class="ticker-content">
        <div class="ticker-label">ISS UPDATE</div>
        <div class="ticker-item"><span class="ticker-time">12:30 UTC</span>Crew Dragon Endeavour docked at Harmony module ¬∑ Crew rotation complete</div>
        <div class="ticker-item"><span class="ticker-time">09:15 UTC</span>EVA scheduled for tomorrow ¬∑ Battery replacement on P4 truss</div>
        <div class="ticker-item"><span class="ticker-time">Yesterday</span>Cygnus cargo spacecraft departed ¬∑ Destructive reentry over Pacific</div>
        <div class="ticker-label">ISS UPDATE</div>
        <div class="ticker-item"><span class="ticker-time">12:30 UTC</span>Crew Dragon Endeavour docked at Harmony module ¬∑ Crew rotation complete</div>
        <div class="ticker-item"><span class="ticker-time">09:15 UTC</span>EVA scheduled for tomorrow ¬∑ Battery replacement on P4 truss</div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Lightstreamer Client for NASA ISS Telemetry -->
  <script src="https://unpkg.com/lightstreamer-client-web/lightstreamer.min.js" data-lightstreamer-ns="Ls"></script>
  
  <script>
    // Global variables
    let map, issMarker, footprintCircle, groundTrack;
    let positionHistory = [];
    let showFootprint = true;
    let showTrack = true;
    let orbitCount = 142850; // Approximate orbit count since 1998
    
    // Three.js variables for 3D ISS model
    let scene, camera, renderer, issModel, controls;
    let targetAttitude = { roll: 0, pitch: 0, yaw: 0 };
    let currentAttitude = { roll: 0, pitch: 0, yaw: 0 };
    // Target quaternion for smooth interpolation
    let targetQuaternion = null;
    let currentQuaternion = null;
    // Solar array references and angles
    let solarArrays = { port: [], starboard: [] };
    let solarArrayAngles = { port: 0, starboard: 0 };
    // Sun and lighting
    let sunLight = null;
    let sunIndicator = null;
    let earthSphere = null;
    // Raycaster for module clicks
    let raycaster = null;
    let mouse = { x: 0, y: 0 };
    
    // Lightstreamer client for NASA telemetry
    let lsClient = null;
    let nasaTelemetry = {
      cabinPressure: null,
      cabinTemp: null,
      o2Level: null,
      co2Level: null,
      crewSleeping: null,
      solarArrayAngle: null,
      // Quaternion for LVLH attitude (w, x, y, z)
      quaternion: { w: 1, x: 0, y: 0, z: 0 },
      betaAngle: null,
      // Derived Euler angles from quaternion
      attitude: { roll: 0, pitch: 0, yaw: 0 }
    };
    
    // NASA Lightstreamer Telemetry Codes (from ISS public feed)
    const TELEMETRY_ITEMS = [
      'NODE3000005',  // US Lab Cabin Pressure (psia)
      'NODE3000004',  // US Lab Cabin Temperature (¬∞F)
      'AIRLOCK000049', // Airlock Cabin Pressure
      'P1000004',     // Port solar array position
      'S1000004',     // Starboard solar array position
      'USLAB000058',  // O2 partial pressure
      'USLAB000059',  // CO2 partial pressure
      'USLAB000053',  // US Lab Temperature
      // LVLH Attitude Quaternion (preferred - more accurate)
      'USLAB000018',  // Quaternion Component 0 (w - scalar)
      'USLAB000019',  // Quaternion Component 1 (x)
      'USLAB000020',  // Quaternion Component 2 (y)
      'USLAB000021',  // Quaternion Component 3 (z)
      // Beta angle (sun angle to orbital plane)
      'USLAB000032'   // Beta Angle
    ];
    
    // Initialize NASA Lightstreamer connection
    function initNASATelemetry() {
      try {
        lsClient = new Ls.LightstreamerClient("https://push.lightstreamer.com", "ISSLIVE");
        
        lsClient.addListener({
          onStatusChange: function(status) {
            console.log("Lightstreamer status: " + status);
            updateConnectionStatus(status);
          }
        });
        
        lsClient.connect();
        
        // Subscribe to telemetry items - don't set DataAdapter, use default
        const subscription = new Ls.Subscription("MERGE", TELEMETRY_ITEMS, ["TimeStamp", "Value", "Status"]);
        subscription.setRequestedSnapshot("yes");
        
        subscription.addListener({
          onItemUpdate: function(update) {
            handleTelemetryUpdate(update);
          },
          onSubscription: function() {
            console.log("NASA telemetry subscription active");
          },
          onSubscriptionError: function(code, message) {
            console.error("Telemetry subscription error:", code, message);
          }
        });
        
        lsClient.subscribe(subscription);
        console.log("NASA Lightstreamer telemetry initialized");
        
      } catch (error) {
        console.error("Failed to initialize NASA telemetry:", error);
      }
    }
    
    // Handle incoming telemetry updates
    function handleTelemetryUpdate(update) {
      const itemName = update.getItemName();
      const value = update.getValue("Value");
      const status = update.getValue("Status");
      
      if (value === null || status === "stale") return;
      
      const numValue = parseFloat(value);
      
      switch(itemName) {
        case 'NODE3000005': // Cabin Pressure (psia)
          nasaTelemetry.cabinPressure = numValue;
          updateTelemetryDisplay('telPressure', numValue.toFixed(1), 'psia');
          break;
        case 'NODE3000004': // Cabin Temp (¬∞F)
        case 'USLAB000053':
          nasaTelemetry.cabinTemp = numValue;
          const tempC = ((numValue - 32) * 5/9).toFixed(1);
          updateTelemetryDisplay('telTemp', tempC, '¬∞C');
          break;
        case 'USLAB000058': // O2 Level
          nasaTelemetry.o2Level = numValue;
          updateTelemetryDisplay('telO2', numValue.toFixed(1), 'mmHg');
          break;
        case 'USLAB000059': // CO2 Level
          nasaTelemetry.co2Level = numValue;
          updateTelemetryDisplay('telCO2', numValue.toFixed(2), 'mmHg');
          break;
        case 'P1000004': // Port Solar Array
        case 'S1000004': // Starboard Solar Array
          nasaTelemetry.solarArrayAngle = numValue;
          updateTelemetryDisplay('telSolar', Math.abs(numValue).toFixed(1), '¬∞');
          break;
        // Quaternion components (LVLH attitude)
        case 'USLAB000018': // Quaternion w (scalar)
          nasaTelemetry.quaternion.w = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000019': // Quaternion x
          nasaTelemetry.quaternion.x = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000020': // Quaternion y
          nasaTelemetry.quaternion.y = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000021': // Quaternion z
          nasaTelemetry.quaternion.z = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000032': // Beta angle
          nasaTelemetry.betaAngle = numValue;
          updateSunPosition();
          break;
      }
      
      // Update all inline module telemetry displays
      updateInlineModuleTelemetry();
    }
    
    // Update all inline module telemetry values
    function updateInlineModuleTelemetry() {
      const tempC = nasaTelemetry.cabinTemp ? ((nasaTelemetry.cabinTemp - 32) * 5/9).toFixed(1) : '--';
      const press = nasaTelemetry.cabinPressure ? nasaTelemetry.cabinPressure.toFixed(1) : '--';
      const o2 = nasaTelemetry.o2Level ? nasaTelemetry.o2Level.toFixed(0) : '--';
      const co2 = nasaTelemetry.co2Level ? nasaTelemetry.co2Level.toFixed(1) : '--';
      const solarAngle = nasaTelemetry.solarArrayAngle ? Math.abs(nasaTelemetry.solarArrayAngle).toFixed(0) : '--';
      
      // US Segment - Left column
      updateTelemEl('destiny-temp', tempC + '¬∞C');
      updateTelemEl('destiny-o2', o2 + ' mmHg');
      updateTelemEl('destiny-co2', co2 + ' mmHg');
      
      updateTelemEl('harmony-press', press + ' psia');
      updateTelemEl('harmony-temp', tempC + '¬∞C');
      
      updateTelemEl('tranq-press', press + ' psia');
      updateTelemEl('tranq-temp', tempC + '¬∞C');
      
      updateTelemEl('unity-press', press + ' psia');
      updateTelemEl('unity-temp', tempC + '¬∞C');
      
      updateTelemEl('quest-press', press + ' psia');
      
      // International/Russian - Right column
      updateTelemEl('columbus-press', press + ' psia');
      updateTelemEl('columbus-temp', tempC + '¬∞C');
      
      updateTelemEl('kibo-press', press + ' psia');
      updateTelemEl('kibo-temp', tempC + '¬∞C');
      
      updateTelemEl('zvezda-press', press + ' psia');
      updateTelemEl('zvezda-temp', tempC + '¬∞C');
      
      updateTelemEl('zarya-press', press + ' psia');
      
      updateTelemEl('nauka-press', press + ' psia');
      
      updateTelemEl('solar-angle', solarAngle + '¬∞');
    }
    
    function updateTelemEl(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }
    
    // Update solar array rotation from telemetry
    function updateSolarArrays() {
      if (!issModel || !window.THREE) return;
      
      // Smooth interpolation toward target angles
      solarArrayAngles.port += (nasaTelemetry.solarArrayAngle - solarArrayAngles.port) * 0.1;
      
      // Apply rotation to solar array meshes (if found)
      solarArrays.port.forEach(mesh => {
        if (mesh) mesh.rotation.y = window.THREE.MathUtils.degToRad(solarArrayAngles.port);
      });
      solarArrays.starboard.forEach(mesh => {
        if (mesh) mesh.rotation.y = window.THREE.MathUtils.degToRad(-solarArrayAngles.port); // Mirror
      });
    }
    
    // Update sun position based on beta angle and orbital position
    function updateSunPosition() {
      if (!sunLight || !sunIndicator || !window.THREE) return;
      
      const beta = nasaTelemetry.betaAngle || 0;
      
      // ISS orbital period is ~92 minutes (5,520,000 ms)
      // Sun position should rotate once per orbit relative to the station
      const orbitPeriodMs = 92 * 60 * 1000;
      const time = (Date.now() % orbitPeriodMs) / orbitPeriodMs * Math.PI * 2;
      
      // Calculate sun direction based on beta angle
      // Beta angle is the angle between the orbital plane and the sun vector
      const betaRad = window.THREE.MathUtils.degToRad(beta);
      const sunDistance = 200;
      
      // Sun position rotates around the orbital plane
      const sunX = Math.cos(time) * Math.cos(betaRad) * sunDistance;
      const sunY = Math.sin(betaRad) * sunDistance;
      const sunZ = Math.sin(time) * Math.cos(betaRad) * sunDistance;
      
      sunLight.position.set(sunX, sunY, sunZ);
      sunIndicator.position.set(sunX * 0.5, sunY * 0.5, sunZ * 0.5);
      
      // Update day/night on Earth sphere
      if (earthSphere) {
        // Determine if ISS is in sunlight or shadow
        const dotProduct = sunX; // Simplified: positive = day side
        const inSunlight = dotProduct > 0;
        earthSphere.material.emissive.setHex(inSunlight ? 0x0a2a5c : 0x050510);
      }
    }
    
    // Convert quaternion to Euler angles (YPR order for ISS - ZYX sequence)
    function quaternionToEuler(q) {
      const w = q.w, x = q.x, y = q.y, z = q.z;
      
      // Roll (x-axis rotation)
      const sinr_cosp = 2 * (w * x + y * z);
      const cosr_cosp = 1 - 2 * (x * x + y * y);
      const roll = Math.atan2(sinr_cosp, cosr_cosp);
      
      // Pitch (y-axis rotation)
      const sinp = 2 * (w * y - z * x);
      let pitch;
      if (Math.abs(sinp) >= 1) {
        pitch = Math.sign(sinp) * Math.PI / 2; // clamp to ¬±90¬∞
      } else {
        pitch = Math.asin(sinp);
      }
      
      // Yaw (z-axis rotation)
      const siny_cosp = 2 * (w * z + x * y);
      const cosy_cosp = 1 - 2 * (y * y + z * z);
      const yaw = Math.atan2(siny_cosp, cosy_cosp);
      
      // Convert to degrees
      return {
        roll: roll * (180 / Math.PI),
        pitch: pitch * (180 / Math.PI),
        yaw: yaw * (180 / Math.PI)
      };
    }
    
    // Update attitude from quaternion telemetry
    function updateAttitudeFromQuaternion() {
      const q = nasaTelemetry.quaternion;
      
      // Check if quaternion is valid (normalized)
      const magnitude = Math.sqrt(q.w*q.w + q.x*q.x + q.y*q.y + q.z*q.z);
      if (magnitude < 0.9 || magnitude > 1.1) return; // Invalid quaternion
      
      // Convert to Euler angles for display
      const euler = quaternionToEuler(q);
      nasaTelemetry.attitude = euler;
      
      // Update display
      updateAttitudeDisplay();
      
      // Update 3D model target quaternion (for smooth slerp interpolation)
      if (window.THREE) {
        // NASA quaternion format: w, x, y, z (scalar first)
        // Three.js quaternion format: x, y, z, w (scalar last)
        if (!targetQuaternion) {
          targetQuaternion = new window.THREE.Quaternion();
        }
        targetQuaternion.set(q.x, q.y, q.z, q.w);
        targetQuaternion.normalize();
      }
      
      // Also update Euler for legacy display
      targetAttitude.roll = euler.roll;
      targetAttitude.pitch = euler.pitch;
      targetAttitude.yaw = euler.yaw;
    }
    
    function updateTelemetryDisplay(elementId, value, unit) {
      const el = document.getElementById(elementId);
      if (el) {
        el.textContent = value + ' ' + unit;
        el.classList.add('live-update');
        setTimeout(() => el.classList.remove('live-update'), 500);
      }
    }
    
    // Update attitude display from quaternion-derived Euler angles
    function updateAttitudeDisplay() {
      const att = nasaTelemetry.attitude;
      
      // Update Roll
      const rollEl = document.getElementById('attRoll');
      if (rollEl && att.roll !== null) {
        rollEl.textContent = att.roll.toFixed(1) + '¬∞';
        rollEl.classList.add('live-update');
        setTimeout(() => rollEl.classList.remove('live-update'), 500);
      }
      
      // Update Pitch  
      const pitchEl = document.getElementById('attPitch');
      if (pitchEl && att.pitch !== null) {
        pitchEl.textContent = att.pitch.toFixed(1) + '¬∞';
        pitchEl.classList.add('live-update');
        setTimeout(() => pitchEl.classList.remove('live-update'), 500);
      }
      
      // Update Yaw
      const yawEl = document.getElementById('attYaw');
      if (yawEl && att.yaw !== null) {
        yawEl.textContent = att.yaw.toFixed(1) + '¬∞';
        yawEl.classList.add('live-update');
        setTimeout(() => yawEl.classList.remove('live-update'), 500);
      }
    }
    
    function updateConnectionStatus(status) {
      const badge = document.getElementById('nasaLiveBadge');
      if (badge) {
        if (status.indexOf('CONNECTED') >= 0) {
          badge.innerHTML = '<span class="live-dot"></span>NASA LIVE';
          badge.style.borderColor = '#7ed321';
        } else if (status.indexOf('CONNECTING') >= 0) {
          badge.innerHTML = '<span class="connecting-dot"></span>CONNECTING';
          badge.style.borderColor = '#ffd60a';
        } else {
          badge.innerHTML = '<span class="offline-dot"></span>OFFLINE';
          badge.style.borderColor = '#ff3b30';
        }
      }
    }
    
    // Initialize map
    function initMap() {
      map = L.map('iss-map', {
        center: [20, 0],
        zoom: 2,
        minZoom: 2,
        maxZoom: 8,
        maxBounds: [[-85, -180], [85, 180]],
        maxBoundsViscosity: 1.0,
        worldCopyJump: false
      });
      
      // Dark tile layer - noWrap prevents repeating
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 19,
        noWrap: true,
        bounds: [[-90, -180], [90, 180]]
      }).addTo(map);
      
      // ISS marker icon
      const issIcon = L.divIcon({
        className: 'iss-marker',
        html: `
          <div class="iss-icon">
            <svg viewBox="0 0 60 36" width="60" height="36">
              <!-- Solar panels -->
              <rect x="6" y="0" width="10" height="36" fill="#ffd60a" opacity="0.9" rx="1"/>
              <rect x="44" y="0" width="10" height="36" fill="#ffd60a" opacity="0.9" rx="1"/>
              <!-- Panel lines -->
              <line x1="11" y1="0" x2="11" y2="36" stroke="#b8860b" stroke-width="0.5"/>
              <line x1="49" y1="0" x2="49" y2="36" stroke="#b8860b" stroke-width="0.5"/>
              <!-- Main truss -->
              <rect x="0" y="14" width="60" height="8" fill="#00bcd4" rx="1"/>
              <!-- Modules -->
              <rect x="20" y="10" width="20" height="16" fill="#00bcd4" rx="2"/>
              <rect x="24" y="12" width="12" height="12" fill="#0d1a2d" rx="1"/>
              <circle cx="30" cy="18" r="3" fill="#00bcd4" opacity="0.5"/>
            </svg>
          </div>
        `,
        iconSize: [60, 36],
        iconAnchor: [30, 18]
      });
      
      // Create marker
      issMarker = L.marker([0, 0], { icon: issIcon }).addTo(map);
      
      // Footprint circle
      footprintCircle = L.circle([0, 0], {
        radius: 2200000,
        color: '#00bcd4',
        fillColor: '#00bcd4',
        fillOpacity: 0.08,
        weight: 1.5,
        dashArray: '8, 4'
      }).addTo(map);
      
      // Ground track
      groundTrack = L.polyline([], {
        color: '#ffd60a',
        weight: 2,
        opacity: 0.5,
        dashArray: '10, 6'
      }).addTo(map);
      
      // Update button states
      document.getElementById('btnFootprint').classList.add('active');
      document.getElementById('btnTrack').classList.add('active');
    }
    
    // Fetch ISS position from our server (proxied API)
    async function updateISSPosition() {
      try {
        // Use server-side proxy instead of direct external API call
        const response = await fetch('/api/iss/position');
        const data = await response.json();
        
        const lat = data.latitude;
        const lng = data.longitude;
        const alt = data.altitude_km;
        const vel = data.velocity_kmh;
        const vis = data.visibility;
        const footprint = data.footprint_km;
        
        // Update marker
        issMarker.setLatLng([lat, lng]);
        
        // Update footprint
        if (footprintCircle) {
          footprintCircle.setLatLng([lat, lng]);
          footprintCircle.setRadius(footprint * 1000 / 2);
        }
        
        // Update ground track
        positionHistory.push([lat, lng]);
        if (positionHistory.length > 200) positionHistory.shift();
        if (groundTrack) groundTrack.setLatLngs(positionHistory);
        
        // Update popup
        issMarker.bindPopup(`
          <strong style="color: #00bcd4;">üõ∞Ô∏è International Space Station</strong><br>
          <hr style="border-color: #1a3a5c; margin: 5px 0;">
          <span style="color: #8b949e;">Lat:</span> ${lat.toFixed(4)}¬∞<br>
          <span style="color: #8b949e;">Lng:</span> ${lng.toFixed(4)}¬∞<br>
          <span style="color: #8b949e;">Alt:</span> ${alt.toFixed(1)} km<br>
          <span style="color: #8b949e;">Speed:</span> ${vel.toFixed(0)} km/h
        `);
        
        // Update data overlay
        document.getElementById('dataLat').textContent = lat.toFixed(2) + '¬∞' + (lat >= 0 ? 'N' : 'S');
        document.getElementById('dataLng').textContent = Math.abs(lng).toFixed(2) + '¬∞' + (lng >= 0 ? 'E' : 'W');
        document.getElementById('dataAlt').textContent = alt.toFixed(0) + ' km';
        document.getElementById('dataVel').textContent = vel.toFixed(0) + ' km/h';
        
        // Update telemetry
        document.getElementById('telAlt').textContent = alt.toFixed(0) + ' km';
        document.getElementById('telVis').textContent = vis.charAt(0).toUpperCase() + vis.slice(1);
        
        // Update stats
        document.getElementById('statVel').textContent = vel.toFixed(0);
        
        // Increment orbit count slowly
        orbitCount += 0.0001;
        document.getElementById('statOrbit').textContent = Math.floor(orbitCount).toLocaleString();
        document.getElementById('orbitBadge').textContent = 'üõ∞Ô∏è ORBIT ' + Math.floor(orbitCount).toLocaleString();
        
        // Get location name (reverse geocode)
        getLocationName(lat, lng);
        
      } catch (error) {
        console.error('Failed to fetch ISS position:', error);
      }
    }
    
    // Get location name from coordinates (via server proxy)
    async function getLocationName(lat, lng) {
      try {
        const response = await fetch(`/api/iss/location/${lat.toFixed(4)},${lng.toFixed(4)}`);
        const data = await response.json();
        
        if (data.location) {
          document.getElementById('overLocation').textContent = data.location;
          document.getElementById('overCountry').textContent = data.country_code || '';
        } else {
          document.getElementById('overLocation').textContent = 'Ocean';
          document.getElementById('overCountry').textContent = 'International Waters';
        }
      } catch {
        document.getElementById('overLocation').textContent = lat.toFixed(1) + '¬∞, ' + lng.toFixed(1) + '¬∞';
        document.getElementById('overCountry').textContent = '';
      }
    }
    
    // Fetch crew data from our server (proxied API)
    async function loadCrew() {
      try {
        const response = await fetch('/api/iss/crew');
        const data = await response.json();
        
        const issCrew = data.crew || [];
        document.getElementById('crewCount').textContent = data.count || issCrew.length;
        
        const crewHtml = issCrew.map(person => {
          // Try to determine agency from name (simplified)
          let agency = 'NASA';
          if (person.name.includes('Kononenko') || person.name.includes('Chub') || person.name.includes('Grebenkin')) agency = 'RSA';
          if (person.name.includes('Mogensen')) agency = 'ESA';
          if (person.name.includes('Furukawa') || person.name.includes('Wakata')) agency = 'JAXA';
          
          return `
            <div class="crew-member">
              <span class="crew-dot"></span>
              ${person.name}
              <span class="crew-agency">${agency}</span>
            </div>
          `;
        }).join('');
        
        document.getElementById('crewList').innerHTML = crewHtml || '<div style="color: var(--text-secondary);">No crew data</div>';
        
      } catch (error) {
        console.error('Failed to load crew:', error);
        document.getElementById('crewList').innerHTML = '<div style="color: var(--text-secondary);">Crew data unavailable</div>';
      }
    }
    
    // Toggle functions
    function toggleFootprint() {
      showFootprint = !showFootprint;
      if (showFootprint) {
        footprintCircle.addTo(map);
        document.getElementById('btnFootprint').classList.add('active');
      } else {
        footprintCircle.remove();
        document.getElementById('btnFootprint').classList.remove('active');
      }
    }
    
    function toggleTrack() {
      showTrack = !showTrack;
      if (showTrack) {
        groundTrack.addTo(map);
        document.getElementById('btnTrack').classList.add('active');
      } else {
        groundTrack.remove();
        document.getElementById('btnTrack').classList.remove('active');
      }
    }
    
    function centerOnISS() {
      const pos = issMarker.getLatLng();
      map.setView(pos, 3, { animate: true });
    }
    
    // Update UTC time
    function updateTime() {
      document.getElementById('utc').textContent = new Date().toUTCString().split(' ')[4] + ' UTC';
    }
    
    // Initialize Three.js 3D ISS Model
    async function init3DISS() {
      // Dynamically import Three.js modules
      const THREE = await import('three');
      const { GLTFLoader } = await import('three/addons/loaders/GLTFLoader.js');
      const { DRACOLoader } = await import('three/addons/loaders/DRACOLoader.js');
      const { OrbitControls } = await import('three/addons/controls/OrbitControls.js');
      
      // Store THREE globally for use in other functions
      window.THREE = THREE;
      
      const container = document.querySelector('.iss-3d-wrapper');
      const canvas = document.getElementById('iss3dCanvas');
      
      // Scene setup
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);
      
      // Camera - positioned above ISS looking down at Earth
      const aspect = container.clientWidth / container.clientHeight;
      camera = new THREE.PerspectiveCamera(50, aspect, 0.1, 2000);
      camera.position.set(0, 80, 20);  // Above and slightly in front
      camera.lookAt(0, -50, 0);  // Look toward Earth below
      
      // Renderer
      renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      
      // Lighting
      const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
      scene.add(ambientLight);
      
      // Main sun light (will be positioned dynamically)
      sunLight = new THREE.DirectionalLight(0xffffff, 2);
      sunLight.position.set(100, 50, 100);
      scene.add(sunLight);
      
      // Sun indicator sphere
      const sunGeo = new THREE.SphereGeometry(3, 16, 16);
      const sunMat = new THREE.MeshBasicMaterial({ color: 0xffdd44 });
      sunIndicator = new THREE.Mesh(sunGeo, sunMat);
      sunIndicator.position.set(80, 40, 80);
      scene.add(sunIndicator);
      
      // Sun glow
      const sunGlowGeo = new THREE.SphereGeometry(5, 16, 16);
      const sunGlowMat = new THREE.MeshBasicMaterial({ 
        color: 0xffaa00, 
        transparent: true, 
        opacity: 0.3 
      });
      const sunGlow = new THREE.Mesh(sunGlowGeo, sunGlowMat);
      sunIndicator.add(sunGlow);
      
      const fillLight = new THREE.DirectionalLight(0x88ccff, 0.3);
      fillLight.position.set(-50, -20, -50);
      scene.add(fillLight);
      
      // Orbit controls for manual rotation
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.enableZoom = true;
      controls.minDistance = 30;
      controls.maxDistance = 300;
      controls.autoRotate = false;
      controls.target.set(0, -20, 0);  // Look below ISS toward Earth
      
      // Add Earth sphere below ISS - fills background when looking down
      const earthGeometry = new THREE.SphereGeometry(800, 64, 64);
      const earthMaterial = new THREE.MeshPhongMaterial({
        color: 0x2266aa,
        emissive: 0x0a1a3a,
        shininess: 5,
        transparent: false
      });
      earthSphere = new THREE.Mesh(earthGeometry, earthMaterial);
      earthSphere.position.set(0, -850, 0); // Earth surface ~50 units below ISS
      scene.add(earthSphere);
      
      // Add day/night terminator line on Earth
      const terminatorGeo = new THREE.TorusGeometry(800, 3, 8, 64);
      const terminatorMat = new THREE.MeshBasicMaterial({ color: 0xff6600 });
      const terminator = new THREE.Mesh(terminatorGeo, terminatorMat);
      terminator.position.copy(earthSphere.position);
      terminator.rotation.x = Math.PI / 2;
      scene.add(terminator);
      
      // Add Earth glow (atmospheric effect)
      const glowGeometry = new THREE.SphereGeometry(820, 64, 64);
      const glowMaterial = new THREE.MeshBasicMaterial({
        color: 0x4488ff,
        transparent: true,
        opacity: 0.12,
        side: THREE.BackSide
      });
      const earthGlow = new THREE.Mesh(glowGeometry, glowMaterial);
      earthGlow.position.copy(earthSphere.position);
      scene.add(earthGlow);
      
      // Add LVLH reference axes (small, subtle)
      // X = velocity direction (red), Y = orbit normal (green), Z = nadir (blue)
      const axesHelper = new THREE.AxesHelper(15);
      axesHelper.position.set(-35, -5, 0);
      scene.add(axesHelper);
      
      // Add velocity vector indicator
      const velocityArrow = new THREE.ArrowHelper(
        new THREE.Vector3(1, 0, 0), // Direction (X = velocity)
        new THREE.Vector3(-35, -5, 0),
        12,
        0xff4444,
        2,
        1.5
      );
      scene.add(velocityArrow);
      
      // Set up DRACO loader for compressed models
      const dracoLoader = new DRACOLoader();
      dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/');
      
      // Load ISS model (High-Detail IGOAL version - 91MB)
      const loader = new GLTFLoader();
      loader.setDRACOLoader(dracoLoader);
      
      const loadingEl = document.getElementById('modelLoading');
      const progressEl = document.getElementById('loadingProgress');
      
      loader.load('/assets/iss-model-hd.glb', 
        function(gltf) {
          issModel = gltf.scene;
          
          // Center and scale the model
          const box = new THREE.Box3().setFromObject(issModel);
          const center = box.getCenter(new THREE.Vector3());
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z);
          const scale = 30 / maxDim;
          
          issModel.scale.setScalar(scale);
          issModel.position.sub(center.multiplyScalar(scale));
          
          scene.add(issModel);
          console.log('ISS HD model loaded successfully');
          
          // Log all mesh names for debugging module identification
          issModel.traverse((child) => {
            if (child.isMesh) {
              console.log('Mesh found:', child.name);
            }
          });
          
          // Hide loading indicator
          if (loadingEl) loadingEl.classList.add('hidden');
        },
        function(progress) {
          const percent = (progress.loaded / progress.total * 100).toFixed(0);
          console.log('Loading ISS HD model: ' + percent + '%');
          if (progressEl) progressEl.textContent = percent + '%';
        },
        function(error) {
          console.error('Error loading ISS HD model:', error);
          // Fallback to lightweight model
          console.log('Falling back to lightweight model...');
          if (progressEl) progressEl.textContent = 'Loading backup...';
          
          loader.load('/assets/iss-model.glb',
            function(gltf) {
              issModel = gltf.scene;
              const box = new THREE.Box3().setFromObject(issModel);
              const center = box.getCenter(new THREE.Vector3());
              const size = box.getSize(new THREE.Vector3());
              const maxDim = Math.max(size.x, size.y, size.z);
              const scale = 30 / maxDim;
              issModel.scale.setScalar(scale);
              issModel.position.sub(center.multiplyScalar(scale));
              scene.add(issModel);
              if (loadingEl) loadingEl.classList.add('hidden');
            },
            null,
            function(err) { console.error('Backup model also failed:', err); }
          );
        }
      );
      
      // Handle resize
      window.addEventListener('resize', on3DResize);
      
      // Start render loop
      animate3D();
    }
    
    function on3DResize() {
      const container = document.querySelector('.iss-3d-wrapper');
      if (!container || !camera || !renderer) return;
      
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    }
    
    function animate3D() {
      requestAnimationFrame(animate3D);
      
      // Apply quaternion rotation to ISS model
      if (issModel && window.THREE && targetQuaternion) {
        // Initialize current quaternion if needed
        if (!currentQuaternion) {
          currentQuaternion = targetQuaternion.clone();
        }
        
        // Smoothly interpolate toward target quaternion (slerp)
        currentQuaternion.slerp(targetQuaternion, 0.05);
        
        // Apply rotation to model
        // Note: NASA quaternion is in LVLH frame, we need to adjust for Three.js coordinate system
        // LVLH: X=velocity, Y=starboard, Z=nadir (down toward Earth)
        // Three.js: X=right, Y=up, Z=toward camera
        // We need to rotate the coordinate system
        
        // Create adjusted quaternion for Three.js display
        // Rotate 90¬∞ around X to align LVLH Z (nadir) with Three.js -Y (down)
        const adjustedQuat = new window.THREE.Quaternion();
        const lvlhToThreeJS = new window.THREE.Quaternion();
        lvlhToThreeJS.setFromEuler(new window.THREE.Euler(-Math.PI/2, 0, 0, 'XYZ'));
        
        adjustedQuat.copy(currentQuaternion);
        adjustedQuat.premultiply(lvlhToThreeJS);
        
        issModel.quaternion.copy(adjustedQuat);
      }
      
      if (controls) controls.update();
      
      // Update sun position animation
      updateSunPosition();
      
      if (renderer && scene && camera) renderer.render(scene, camera);
    }
    
    // ISS Module data for telemetry popups (based on actual mesh names in IGOAL model)
    const moduleData = {
      'destiny': { name: 'Destiny Laboratory', tag: 'USLAB', telemetry: ['O2', 'CO2', 'Temperature'] },
      'uslab': { name: 'Destiny Laboratory', tag: 'USLAB', telemetry: ['O2', 'CO2', 'Temperature'] },
      'harmony': { name: 'Harmony (Node 2)', tag: 'NODE2', telemetry: ['Pressure', 'Temperature'] },
      'node2': { name: 'Harmony (Node 2)', tag: 'NODE2', telemetry: ['Pressure', 'Temperature'] },
      'tranquility': { name: 'Tranquility (Node 3)', tag: 'NODE3', telemetry: ['Pressure', 'Temperature'] },
      'node3': { name: 'Tranquility (Node 3)', tag: 'NODE3', telemetry: ['Pressure', 'Temperature'] },
      'unity': { name: 'Unity (Node 1)', tag: 'NODE1', telemetry: ['Pressure', 'Temperature'] },
      'node1': { name: 'Unity (Node 1)', tag: 'NODE1', telemetry: ['Pressure', 'Temperature'] },
      'columbus': { name: 'Columbus Laboratory', tag: 'COL', telemetry: ['Pressure', 'Temperature'] },
      'kibo': { name: 'Kibo Laboratory', tag: 'JEM', telemetry: ['Pressure', 'Temperature'] },
      'jem': { name: 'Kibo Laboratory', tag: 'JEM', telemetry: ['Pressure', 'Temperature'] },
      'quest': { name: 'Quest Airlock', tag: 'AIRLOCK', telemetry: ['Pressure', 'EVA Status'] },
      'airlock': { name: 'Quest Airlock', tag: 'AIRLOCK', telemetry: ['Pressure', 'EVA Status'] },
      'cupola': { name: 'Cupola', tag: 'CUPOLA', telemetry: ['Shutter Status'] },
      'zvezda': { name: 'Zvezda Service Module', tag: 'SM', telemetry: ['Pressure', 'Life Support'] },
      'zarya': { name: 'Zarya (FGB)', tag: 'FGB', telemetry: ['Pressure', 'Power'] },
      'fgb': { name: 'Zarya (FGB)', tag: 'FGB', telemetry: ['Pressure', 'Power'] },
      'nauka': { name: 'Nauka (MLM)', tag: 'MLM', telemetry: ['Pressure', 'Status'] },
      'mlm': { name: 'Nauka (MLM)', tag: 'MLM', telemetry: ['Pressure', 'Status'] },
      'solar': { name: 'Solar Arrays', tag: 'SAW', telemetry: ['Array Angle', 'Power'] },
      'saw': { name: 'Solar Arrays', tag: 'SAW', telemetry: ['Array Angle', 'Power'] },
      'pma': { name: 'Pressurized Mating Adapter', tag: 'PMA', telemetry: ['Docking Status'] },
      'beam': { name: 'BEAM Module', tag: 'BEAM', telemetry: ['Pressure', 'Temperature'] },
      'bishop': { name: 'Bishop Airlock', tag: 'BISHOP', telemetry: ['Pressure', 'Status'] },
      'ams': { name: 'Alpha Magnetic Spectrometer', tag: 'AMS', telemetry: ['Particle Count', 'Status'] },
      'radiator': { name: 'Thermal Radiator', tag: 'RAD', telemetry: ['Temperature', 'Coolant'] },
      'truss': { name: 'Integrated Truss', tag: 'ITS', telemetry: ['Status'] },
      'canadarm': { name: 'Canadarm2 (SSRMS)', tag: 'SSRMS', telemetry: ['Joint Angles', 'Status'] },
      'dragon': { name: 'SpaceX Dragon', tag: 'DRAGON', telemetry: ['Docking Status', 'Pressure'] },
      'cygnus': { name: 'Cygnus Cargo', tag: 'CYGNUS', telemetry: ['Docking Status'] },
      'soyuz': { name: 'Soyuz Spacecraft', tag: 'SOYUZ', telemetry: ['Docking Status'] },
      'progress': { name: 'Progress Cargo', tag: 'PROGRESS', telemetry: ['Docking Status'] },
      'prichal': { name: 'Prichal Module', tag: 'PRICHAL', telemetry: ['Docking Status'] },
      'elc': { name: 'Express Logistics Carrier', tag: 'ELC', telemetry: ['Payload Status'] }
    };
    
    // Setup module click interaction
    // Toggle module popup - allows multiple to be open at once
    function toggleModule(moduleKey) {
      const card = document.querySelector(`.module-card[data-module="${moduleKey}"]`);
      if (!card) return;
      
      // Toggle active state (allows multiple active)
      card.classList.toggle('active');
      
      // If now active, populate the inline popup
      if (card.classList.contains('active')) {
        updateInlinePopup(moduleKey);
      }
    }
    
    // Update inline popup content for a module
    function updateInlinePopup(moduleKey) {
      const popup = document.getElementById(`popup-${moduleKey}`);
      if (!popup) return;
      
      const moduleInfo = moduleData[moduleKey] || moduleData[moduleKey.toLowerCase()];
      if (!moduleInfo) return;
      
      let html = `<div class="popup-header">
        <span class="popup-name">${moduleInfo.name}</span>
        <span class="popup-tag">${moduleInfo.tag}</span>
      </div><div class="popup-content">`;
      
      // Temperature (show for pressurized modules)
      if (['USLAB','NODE2','NODE3','NODE1','COL','JEM','SM','FGB','MLM','AIRLOCK','BISHOP','CUPOLA','BEAM'].includes(moduleInfo.tag)) {
        if (nasaTelemetry.cabinTemp !== null) {
          const tempC = ((nasaTelemetry.cabinTemp - 32) * 5/9).toFixed(1);
          const status = (tempC > 18 && tempC < 26) ? 'nominal' : 'warning';
          html += `<div class="popup-row"><span class="popup-label">Temp</span><span class="popup-value ${status}">${tempC}¬∞C</span></div>`;
        }
      }
      
      // Pressure (show for pressurized modules)
      if (['USLAB','NODE2','NODE3','NODE1','COL','JEM','SM','FGB','MLM','AIRLOCK','BISHOP','CUPOLA','BEAM'].includes(moduleInfo.tag)) {
        if (nasaTelemetry.cabinPressure !== null) {
          const status = (nasaTelemetry.cabinPressure > 14.5 && nasaTelemetry.cabinPressure < 15.0) ? 'nominal' : 'warning';
          html += `<div class="popup-row"><span class="popup-label">Press</span><span class="popup-value ${status}">${nasaTelemetry.cabinPressure.toFixed(2)}</span></div>`;
        }
      }
      
      // O2/CO2 for US Lab
      if (moduleInfo.tag === 'USLAB') {
        if (nasaTelemetry.o2Level !== null) {
          html += `<div class="popup-row"><span class="popup-label">O‚ÇÇ</span><span class="popup-value nominal">${nasaTelemetry.o2Level.toFixed(1)}</span></div>`;
        }
        if (nasaTelemetry.co2Level !== null) {
          const status = nasaTelemetry.co2Level < 5.3 ? 'nominal' : 'warning';
          html += `<div class="popup-row"><span class="popup-label">CO‚ÇÇ</span><span class="popup-value ${status}">${nasaTelemetry.co2Level.toFixed(2)}</span></div>`;
        }
      }
      
      // Solar Array specific
      if (moduleInfo.tag === 'SAW') {
        if (nasaTelemetry.solarArrayAngle !== null) {
          html += `<div class="popup-row"><span class="popup-label">Angle</span><span class="popup-value nominal">${Math.abs(nasaTelemetry.solarArrayAngle).toFixed(1)}¬∞</span></div>`;
        }
        html += `<div class="popup-row"><span class="popup-label">Power</span><span class="popup-value nominal">~30kW</span></div>`;
      }
      
      // Cupola shutters
      if (moduleInfo.tag === 'CUPOLA') {
        html += `<div class="popup-row"><span class="popup-label">Shutter</span><span class="popup-value nominal">OPEN</span></div>`;
      }
      
      // Airlock status
      if (moduleInfo.tag === 'AIRLOCK' || moduleInfo.tag === 'BISHOP') {
        html += `<div class="popup-row"><span class="popup-label">Hatch</span><span class="popup-value nominal">SEAL</span></div>`;
      }
      
      // Status row for all
      html += `<div class="popup-row"><span class="popup-label">Status</span><span class="popup-value nominal">NOM</span></div>`;
      html += '</div>';
      
      popup.innerHTML = html;
    }
    
    // Update all active module popups (called when telemetry updates)
    function updateAllActivePopups() {
      document.querySelectorAll('.module-card.active').forEach(card => {
        const moduleKey = card.dataset.module;
        updateInlinePopup(moduleKey);
      });
    }
    
    // Update attitude display from telemetry
    function updateAttitudeDisplay() {
      if (nasaTelemetry.attitude.roll !== null) {
        document.getElementById('attRoll').textContent = nasaTelemetry.attitude.roll.toFixed(1) + '¬∞';
        targetAttitude.roll = nasaTelemetry.attitude.roll;
      }
      if (nasaTelemetry.attitude.pitch !== null) {
        document.getElementById('attPitch').textContent = nasaTelemetry.attitude.pitch.toFixed(1) + '¬∞';
        targetAttitude.pitch = nasaTelemetry.attitude.pitch;
      }
      if (nasaTelemetry.attitude.yaw !== null) {
        document.getElementById('attYaw').textContent = nasaTelemetry.attitude.yaw.toFixed(1) + '¬∞';
        targetAttitude.yaw = nasaTelemetry.attitude.yaw;
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      init3DISS(); // Initialize 3D ISS model
      updateISSPosition();
      loadCrew();
      updateTime();
      
      // Initialize NASA Lightstreamer telemetry
      initNASATelemetry();
      
      // Update position every 5 seconds
      setInterval(updateISSPosition, 5000);
      
      // Update time every second
      setInterval(updateTime, 1000);
    });
  </script>
</body>
</html>
