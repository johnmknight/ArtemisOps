<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ISS Tracker Component</title>
  <!-- Import map for Three.js modules -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Lightstreamer for NASA telemetry -->
  <script src="https://unpkg.com/lightstreamer-client-web@9.0.0/lightstreamer-umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0a1628;
      --bg-panel: #0d1a2d;
      --border-color: #1a3a5c;
      --text-primary: #ffffff;
      --text-secondary: #8b949e;
      --text-accent: #00bcd4;
      --accent-cyan: #00bcd4;
      --accent-green: #7ed321;
      --accent-yellow: #ffd60a;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    
    .tracker-container {
      display: flex;
      height: 100%;
      width: 100%;
    }
    
    /* Left side - Map */
    .map-section {
      flex: 1;
      position: relative;
      min-width: 0;
      border-right: 1px solid var(--border-color);
    }
    
    #iss-map {
      width: 100%;
      height: 100%;
      background: var(--bg-primary);
    }
    
    .data-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(10, 22, 40, 0.95);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 12px;
      z-index: 1000;
      min-width: 180px;
    }
    
    .data-row {
      display: flex;
      gap: 16px;
      margin-bottom: 8px;
    }
    .data-row:last-child { margin-bottom: 0; }
    
    .data-item label {
      font-size: 0.55rem;
      color: var(--text-secondary);
      letter-spacing: 1px;
      display: block;
      margin-bottom: 2px;
    }
    .data-item span {
      font-size: 0.95rem;
      color: var(--text-primary);
    }
    
    .map-controls {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 6px;
      z-index: 1000;
    }
    
    .ctrl-btn {
      background: rgba(10, 22, 40, 0.9);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 6px 12px;
      font-family: inherit;
      font-size: 0.7em;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
    }
    .ctrl-btn:hover {
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }
    .ctrl-btn.active {
      background: rgba(0, 188, 212, 0.2);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }
    
    /* Right side - Station Systems */
    .station-panel {
      width: 50%;
      min-width: 400px;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      background: var(--bg-panel);
    }
    
    .panel-header {
      padding: 10px 14px;
      background: rgba(0, 188, 212, 0.1);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--accent-cyan);
    }
    .live-badge {
      font-size: 0.5rem;
      color: var(--accent-green);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
</style>
</head>
<body>
  <div class="tracker-container">
    <!-- Map Section -->
    <div class="map-section">
      <div id="iss-map"></div>
      <div class="data-overlay">
        <div class="data-row">
          <div class="data-item">
            <label>LATITUDE</label>
            <span id="dataLat">--¬∞</span>
          </div>
          <div class="data-item">
            <label>LONGITUDE</label>
            <span id="dataLng">--¬∞</span>
          </div>
        </div>
        <div class="data-row">
          <div class="data-item">
            <label>ALTITUDE</label>
            <span id="dataAlt">-- km</span>
          </div>
          <div class="data-item">
            <label>VELOCITY</label>
            <span id="dataVel">-- km/h</span>
          </div>
        </div>
      </div>
      <div class="map-controls">
        <button class="ctrl-btn active" id="btnFootprint" onclick="ISSTracker.toggleFootprint()">Footprint</button>
        <button class="ctrl-btn active" id="btnTrack" onclick="ISSTracker.toggleTrack()">Track</button>
        <button class="ctrl-btn" onclick="ISSTracker.centerOnISS()">Center</button>
      </div>
    </div>

    <!-- Station Systems Panel -->
    <div class="station-panel">
      <div class="panel-header">
        <span class="panel-title">‚ö° STATION SYSTEMS</span>
        <div class="live-badge"><span class="live-dot"></span>NASA LIVE</div>
      </div>
      
      <!-- Dual 3D Views -->
      <div class="dual-view-container">
        <div class="iss-view" id="nadirView">
          <div class="view-label">NADIR VIEW</div>
          <canvas id="nadirCanvas"></canvas>
          <div class="axis-indicator">
            <span class="axis-z">‚ÜêTruss‚Üí</span> <span class="axis-x">‚ÜëVel</span>
          </div>
          <div class="loading-overlay" id="nadirLoading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading ISS Model...</div>
            <div class="loading-progress" id="nadirProgress">0%</div>
          </div>
        </div>
        
        <div class="iss-view" id="velocityView">
          <div class="view-label">VELOCITY VIEW</div>
          <canvas id="velocityCanvas"></canvas>
          <div class="axis-indicator">
            <span class="axis-z">‚ÜêTruss‚Üí</span> <span class="axis-y">‚ÜìNadir</span>
          </div>
          <div class="loading-overlay" id="velocityLoading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading ISS Model...</div>
            <div class="loading-progress" id="velocityProgress">0%</div>
          </div>
        </div>
      </div>
      
      <!-- Telemetry Grid -->
      <div class="telemetry-grid-panel">
        <div class="telem-header">
          <span>üìä STATION TELEMETRY</span>
          <span class="attitude-display" id="attitudeDisplay">R:--¬∞ P:--¬∞</span>
        </div>
        <div class="telemetry-grid">
          <div class="telem-item">
            <div class="telem-label">CABIN TEMP</div>
            <div class="telem-value" id="telTemp">--¬∞C</div>
          </div>
          <div class="telem-item">
            <div class="telem-label">PRESSURE</div>
            <div class="telem-value" id="telPressure">-- psia</div>
          </div>
          <div class="telem-item">
            <div class="telem-label">O‚ÇÇ LEVEL</div>
            <div class="telem-value" id="telO2">-- mmHg</div>
          </div>
          <div class="telem-item">
            <div class="telem-label">CO‚ÇÇ LEVEL</div>
            <div class="telem-value" id="telCO2">-- mmHg</div>
          </div>
          <div class="telem-item">
            <div class="telem-label">SOLAR ARRAY</div>
            <div class="telem-value" id="telSolar">--¬∞</div>
          </div>
          <div class="telem-item">
            <div class="telem-label">ATTITUDE</div>
            <div class="telem-value" id="attitudeYaw">Y:--¬∞</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Dual 3D View Styles */
    .dual-view-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      min-height: 0;
    }
    
    .iss-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: #000;
      min-width: 0;
    }
    .iss-view:first-child {
      border-right: 1px solid var(--border-color);
    }
    
    .view-label {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.6rem;
      color: var(--text-accent);
      background: rgba(0, 0, 0, 0.7);
      padding: 4px 10px;
      border-radius: 3px;
      z-index: 10;
      letter-spacing: 1px;
      border: 1px solid var(--border-color);
    }
    
    .iss-view canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    
    .axis-indicator {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 0.55rem;
      font-family: 'Courier New', monospace;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 3px;
    }
    .axis-x { color: #ff6b6b; }
    .axis-y { color: #51cf66; }
    .axis-z { color: #339af0; }
    
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }
    .loading-overlay.hidden { display: none; }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-cyan);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 12px;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }
    .loading-progress {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--accent-cyan);
    }
    
    /* Telemetry Grid Panel */
    .telemetry-grid-panel {
      height: 120px;
      min-height: 120px;
      background: rgba(13, 26, 45, 0.95);
      border-top: 1px solid var(--border-color);
      padding: 8px 12px;
    }
    
    .telem-header {
      font-size: 0.55rem;
      color: var(--text-accent);
      letter-spacing: 1px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }
    .attitude-display {
      color: var(--accent-yellow);
    }
    
    .telemetry-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .telem-item {
      background: rgba(0, 0, 0, 0.4);
      padding: 6px 8px;
      border-radius: 3px;
      border: 1px solid var(--border-color);
    }
    .telem-label {
      font-size: 0.5rem;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }
    .telem-value {
      font-size: 0.85rem;
      color: var(--accent-cyan);
      font-weight: bold;
    }
    
    /* Leaflet customizations */
    .leaflet-container { background: var(--bg-primary) !important; }
    .leaflet-control-attribution {
      background: rgba(13, 26, 45, 0.8) !important;
      color: var(--text-secondary) !important;
      font-size: 10px !important;
    }
    .leaflet-control-attribution a { color: var(--accent-cyan) !important; }
    .leaflet-control-zoom a {
      background: var(--bg-panel) !important;
      color: var(--accent-cyan) !important;
      border-color: var(--border-color) !important;
    }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
      background: var(--bg-panel) !important;
      color: var(--text-primary) !important;
    }
  </style>


  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  
  <script type="module">
    // NASA Telemetry State
    let targetAttitude = { roll: 0, pitch: 0, yaw: 0 };
    let targetQuaternion = null;
    let currentQuaternion = null;
    
    const nasaTelemetry = {
      cabinPressure: null,
      cabinTemp: null,
      o2Level: null,
      co2Level: null,
      solarArrayAngle: null,
      quaternion: { w: 1, x: 0, y: 0, z: 0 }
    };
    
    // NASA Lightstreamer telemetry items
    const TELEMETRY_ITEMS = [
      'NODE3000005',  // Cabin Pressure
      'NODE3000004',  // Cabin Temp
      'USLAB000058',  // O2 Level
      'USLAB000059',  // CO2 Level
      'P1000004',     // Port Solar Array
      'USLAB000018',  // Quaternion w
      'USLAB000019',  // Quaternion x
      'USLAB000020',  // Quaternion y
      'USLAB000021'   // Quaternion z
    ];
    
    // 3D View State
    let nadirScene, nadirCamera, nadirRenderer, issModelNadir;
    let velocityScene, velocityCamera, velocityRenderer, issModelVelocity;
    
    // ISS Tracker Module
    const ISSTracker = {
      map: null,
      issMarker: null,
      footprintCircle: null,
      groundTrack: null,
      positionHistory: [],
      showFootprint: true,
      showTrack: true,
      
      async init() {
        this.map = L.map('iss-map', {
          center: [20, 0],
          zoom: 2,
          minZoom: 1,
          maxZoom: 8,
          worldCopyJump: true
        });
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 19
        }).addTo(this.map);
        
        const issIcon = L.icon({
          iconUrl: '../assets/icons/spacecraft/big-iss-icon.png',
          iconSize: [80, 48],
          iconAnchor: [40, 24]
        });
        
        this.issMarker = L.marker([0, 0], { icon: issIcon }).addTo(this.map);
        
        this.footprintCircle = L.circle([0, 0], {
          radius: 2200000,
          color: '#00bcd4',
          fillColor: '#00bcd4',
          fillOpacity: 0.08,
          weight: 1.5,
          dashArray: '8, 4'
        }).addTo(this.map);
        
        this.groundTrack = L.polyline([], {
          color: '#ffd60a',
          weight: 2,
          opacity: 0.5,
          dashArray: '10, 6'
        }).addTo(this.map);
        
        await this.updatePosition();
        setInterval(() => this.updatePosition(), 5000);
      },
      
      async updatePosition() {
        try {
          const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
          const data = await response.json();
          
          const lat = data.latitude;
          const lng = data.longitude;
          
          this.issMarker.setLatLng([lat, lng]);
          
          if (this.footprintCircle) {
            this.footprintCircle.setLatLng([lat, lng]);
            this.footprintCircle.setRadius(data.footprint * 1000 / 2);
          }
          
          this.positionHistory.push([lat, lng]);
          if (this.positionHistory.length > 200) this.positionHistory.shift();
          if (this.groundTrack) this.groundTrack.setLatLngs(this.positionHistory);
          
          document.getElementById('dataLat').textContent = lat.toFixed(2) + '¬∞' + (lat >= 0 ? 'N' : 'S');
          document.getElementById('dataLng').textContent = Math.abs(lng).toFixed(2) + '¬∞' + (lng >= 0 ? 'E' : 'W');
          document.getElementById('dataAlt').textContent = Math.round(data.altitude) + ' km';
          document.getElementById('dataVel').textContent = Math.round(data.velocity) + ' km/h';
          
        } catch (error) {
          console.error('Failed to fetch ISS position:', error);
        }
      },
      
      toggleFootprint() {
        this.showFootprint = !this.showFootprint;
        document.getElementById('btnFootprint').classList.toggle('active', this.showFootprint);
        if (this.showFootprint) this.footprintCircle.addTo(this.map);
        else this.footprintCircle.remove();
      },
      
      toggleTrack() {
        this.showTrack = !this.showTrack;
        document.getElementById('btnTrack').classList.toggle('active', this.showTrack);
        if (this.showTrack) this.groundTrack.addTo(this.map);
        else this.groundTrack.remove();
      },
      
      centerOnISS() {
        const pos = this.issMarker.getLatLng();
        this.map.setView(pos, 3, { animate: true });
      }
    };
    
    // Expose to window for button handlers
    window.ISSTracker = ISSTracker;

    
    // NASA Lightstreamer Telemetry
    function initNASATelemetry() {
      try {
        const lsClient = new Ls.LightstreamerClient("https://push.lightstreamer.com", "ISSLIVE");
        
        lsClient.addListener({
          onStatusChange: function(status) {
            console.log("Lightstreamer status:", status);
          }
        });
        
        lsClient.connect();
        
        const subscription = new Ls.Subscription("MERGE", TELEMETRY_ITEMS, ["TimeStamp", "Value", "Status"]);
        subscription.setRequestedSnapshot("yes");
        
        subscription.addListener({
          onItemUpdate: function(update) {
            handleTelemetryUpdate(update);
          },
          onSubscription: function() {
            console.log("NASA telemetry subscription active");
          }
        });
        
        lsClient.subscribe(subscription);
        console.log("NASA Lightstreamer telemetry initialized");
        
      } catch (error) {
        console.error("Failed to initialize NASA telemetry:", error);
      }
    }
    
    function handleTelemetryUpdate(update) {
      const itemName = update.getItemName();
      const value = update.getValue("Value");
      const status = update.getValue("Status");
      
      if (value === null || status === "stale") return;
      
      const numValue = parseFloat(value);
      
      switch(itemName) {
        case 'NODE3000005': // Cabin Pressure
          nasaTelemetry.cabinPressure = numValue;
          updateTelemetryDisplay('telPressure', numValue.toFixed(1) + ' psia');
          break;
        case 'NODE3000004': // Cabin Temp
          nasaTelemetry.cabinTemp = numValue;
          const tempC = ((numValue - 32) * 5/9).toFixed(1);
          updateTelemetryDisplay('telTemp', tempC + '¬∞C');
          break;
        case 'USLAB000058': // O2 Level
          nasaTelemetry.o2Level = numValue;
          updateTelemetryDisplay('telO2', numValue.toFixed(1) + ' mmHg');
          break;
        case 'USLAB000059': // CO2 Level
          nasaTelemetry.co2Level = numValue;
          updateTelemetryDisplay('telCO2', numValue.toFixed(2) + ' mmHg');
          break;
        case 'P1000004': // Solar Array
          nasaTelemetry.solarArrayAngle = numValue;
          updateTelemetryDisplay('telSolar', Math.abs(numValue).toFixed(1) + '¬∞');
          break;
        case 'USLAB000018': // Quaternion w
          nasaTelemetry.quaternion.w = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000019': // Quaternion x
          nasaTelemetry.quaternion.x = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000020': // Quaternion y
          nasaTelemetry.quaternion.y = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000021': // Quaternion z
          nasaTelemetry.quaternion.z = numValue;
          updateAttitudeFromQuaternion();
          break;
      }
    }
    
    function updateTelemetryDisplay(elementId, value) {
      const el = document.getElementById(elementId);
      if (el) el.textContent = value;
    }
    
    function quaternionToEuler(q) {
      const sinr_cosp = 2 * (q.w * q.x + q.y * q.z);
      const cosr_cosp = 1 - 2 * (q.x * q.x + q.y * q.y);
      const roll = Math.atan2(sinr_cosp, cosr_cosp) * (180 / Math.PI);
      
      const sinp = 2 * (q.w * q.y - q.z * q.x);
      let pitch;
      if (Math.abs(sinp) >= 1) {
        pitch = Math.sign(sinp) * 90;
      } else {
        pitch = Math.asin(sinp) * (180 / Math.PI);
      }
      
      const siny_cosp = 2 * (q.w * q.z + q.x * q.y);
      const cosy_cosp = 1 - 2 * (q.y * q.y + q.z * q.z);
      const yaw = Math.atan2(siny_cosp, cosy_cosp) * (180 / Math.PI);
      
      return { roll, pitch, yaw };
    }
    
    function updateAttitudeFromQuaternion() {
      const q = nasaTelemetry.quaternion;
      const magnitude = Math.sqrt(q.w*q.w + q.x*q.x + q.y*q.y + q.z*q.z);
      if (magnitude < 0.9 || magnitude > 1.1) return;
      
      const euler = quaternionToEuler(q);
      
      if (window.THREE) {
        if (!targetQuaternion) {
          targetQuaternion = new window.THREE.Quaternion();
        }
        targetQuaternion.set(q.x, q.y, q.z, q.w);
        targetQuaternion.normalize();
      }
      
      targetAttitude.roll = euler.roll;
      targetAttitude.pitch = euler.pitch;
      targetAttitude.yaw = euler.yaw;
      
      const attDisp = document.getElementById('attitudeDisplay');
      const attYaw = document.getElementById('attitudeYaw');
      if (attDisp) attDisp.textContent = `R:${euler.roll.toFixed(1)}¬∞ P:${euler.pitch.toFixed(1)}¬∞`;
      if (attYaw) attYaw.textContent = `Y:${euler.yaw.toFixed(1)}¬∞`;
    }

    
    // Dual 3D View System
    async function initDual3DISS() {
      const THREE = await import('three');
      const { GLTFLoader } = await import('three/addons/loaders/GLTFLoader.js');
      const { DRACOLoader } = await import('three/addons/loaders/DRACOLoader.js');
      
      window.THREE = THREE;
      
      setupDualView('nadir', THREE);
      setupDualView('velocity', THREE);
      await loadDualISSModel(THREE, GLTFLoader, DRACOLoader);
      animateDual3D();
      window.addEventListener('resize', onDualResize);
    }
    
    function setupDualView(viewName, THREE) {
      const canvas = document.getElementById(viewName + 'Canvas');
      const container = document.getElementById(viewName + 'View');
      if (!canvas || !container) return;
      
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);
      
      const aspect = container.clientWidth / container.clientHeight;
      const frustumSize = 80;
      const camera = new THREE.OrthographicCamera(
        -frustumSize * aspect / 2, frustumSize * aspect / 2,
        frustumSize / 2, -frustumSize / 2, 0.1, 1000
      );
      
      // Camera positions - Model: X=velocity, Y=nadir/zenith, Z=truss
      if (viewName === 'nadir') {
        camera.position.set(0, -100, 0);
        camera.up.set(1, 0, 0);
        camera.lookAt(0, 0, 0);
      } else {
        camera.position.set(100, 0, 0);
        camera.up.set(0, -1, 0);
        camera.lookAt(0, 0, 0);
      }
      
      const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
      directionalLight.position.set(50, 30, 50);
      scene.add(directionalLight);
      
      if (viewName === 'nadir') {
        nadirScene = scene;
        nadirCamera = camera;
        nadirRenderer = renderer;
      } else {
        velocityScene = scene;
        velocityCamera = camera;
        velocityRenderer = renderer;
      }
    }
    
    async function loadDualISSModel(THREE, GLTFLoader, DRACOLoader) {
      const dracoLoader = new DRACOLoader();
      dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/gltf/');
      const loader = new GLTFLoader();
      loader.setDRACOLoader(dracoLoader);
      
      return new Promise((resolve, reject) => {
        loader.load('../assets/iss-model-hd.glb',
          (gltf) => {
            const model = gltf.scene;
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            model.position.sub(center);
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 50 / maxDim;
            model.scale.setScalar(scale);
            
            issModelNadir = model;
            issModelVelocity = model.clone();
            
            if (nadirScene) nadirScene.add(issModelNadir);
            if (velocityScene) velocityScene.add(issModelVelocity);
            
            document.getElementById('nadirLoading')?.classList.add('hidden');
            document.getElementById('velocityLoading')?.classList.add('hidden');
            resolve();
          },
          (progress) => {
            if (progress.total > 0) {
              const pct = Math.round((progress.loaded / progress.total) * 100);
              const nadirProg = document.getElementById('nadirProgress');
              const velProg = document.getElementById('velocityProgress');
              if (nadirProg) nadirProg.textContent = pct + '%';
              if (velProg) velProg.textContent = pct + '%';
            }
          },
          (error) => {
            console.error('Error loading ISS model:', error);
            reject(error);
          }
        );
      });
    }
    
    function animateDual3D() {
      requestAnimationFrame(animateDual3D);
      
      if (issModelNadir && issModelVelocity && window.THREE && targetQuaternion) {
        if (!currentQuaternion) currentQuaternion = targetQuaternion.clone();
        currentQuaternion.slerp(targetQuaternion, 0.05);
        issModelNadir.quaternion.copy(currentQuaternion);
        issModelVelocity.quaternion.copy(currentQuaternion);
      }
      
      if (nadirRenderer && nadirScene && nadirCamera) nadirRenderer.render(nadirScene, nadirCamera);
      if (velocityRenderer && velocityScene && velocityCamera) velocityRenderer.render(velocityScene, velocityCamera);
    }
    
    function onDualResize() {
      const frustumSize = 80;
      
      const nadirContainer = document.getElementById('nadirView');
      if (nadirCamera && nadirRenderer && nadirContainer) {
        const aspect = nadirContainer.clientWidth / nadirContainer.clientHeight;
        nadirCamera.left = -frustumSize * aspect / 2;
        nadirCamera.right = frustumSize * aspect / 2;
        nadirCamera.top = frustumSize / 2;
        nadirCamera.bottom = -frustumSize / 2;
        nadirCamera.updateProjectionMatrix();
        nadirRenderer.setSize(nadirContainer.clientWidth, nadirContainer.clientHeight);
      }
      
      const velContainer = document.getElementById('velocityView');
      if (velocityCamera && velocityRenderer && velContainer) {
        const aspect = velContainer.clientWidth / velContainer.clientHeight;
        velocityCamera.left = -frustumSize * aspect / 2;
        velocityCamera.right = frustumSize * aspect / 2;
        velocityCamera.top = frustumSize / 2;
        velocityCamera.bottom = -frustumSize / 2;
        velocityCamera.updateProjectionMatrix();
        velocityRenderer.setSize(velContainer.clientWidth, velContainer.clientHeight);
      }
    }
    
    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
      ISSTracker.init();
      initDual3DISS();
      initNASATelemetry();
    });
  </script>
</body>
</html>
