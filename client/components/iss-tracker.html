<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ISS Tracker Component</title>
  <!-- Import map for Three.js -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Lightstreamer for NASA telemetry -->
  <script src="https://unpkg.com/lightstreamer-client-web/lightstreamer.min.js" data-lightstreamer-ns="Ls"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0a1628;
      --bg-panel: #0d1a2d;
      --border-color: #1a3a5c;
      --text-primary: #ffffff;
      --text-secondary: #8b949e;
      --text-accent: #00bcd4;
      --iss-color: #00bcd4;
      --success-color: #7ed321;
      --accent-yellow: #ffd60a;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    
    .mission-control {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    /* Header */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 24px;
      background: linear-gradient(180deg, #0d1a2d 0%, #0a1628 100%);
      border-bottom: 1px solid var(--border-color);
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .agency-logos { display: flex; gap: 6px; }
    .agency-logo {
      width: 32px; height: 32px; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      font-size: 8px; font-weight: bold;
    }
    .mission-info h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: 3px; }
    .mission-subtitle { font-size: 0.75rem; color: var(--iss-color); letter-spacing: 1px; }
    .header-center { display: flex; align-items: center; gap: 24px; }
    .orbit-badge {
      background: rgba(0, 188, 212, 0.2);
      border: 1px solid var(--iss-color);
      padding: 6px 14px; border-radius: 4px;
      font-size: 0.7rem; font-weight: 600;
      color: var(--iss-color); letter-spacing: 1px;
    }
    .current-time { font-family: 'Courier New', monospace; font-size: 0.9rem; color: var(--text-secondary); }
    
    /* Main Content - 50/50 Grid */
    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      padding: 12px 16px;
      min-height: 0;
      gap: 12px;
    }
    
    /* Map Container */
    .map-container {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(0, 188, 212, 0.1);
      border-bottom: 1px solid var(--border-color);
    }
    .map-title { font-size: 0.75rem; font-weight: 600; letter-spacing: 1px; color: var(--iss-color); }
    .map-controls { display: flex; gap: 8px; }
    .map-btn {
      background: rgba(0, 188, 212, 0.2);
      border: 1px solid var(--iss-color);
      color: var(--iss-color);
      padding: 4px 10px;
      font-size: 0.65rem;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .map-btn:hover { background: rgba(0, 188, 212, 0.3); }
    .map-btn.active { background: var(--iss-color); color: #000; }
    
    #iss-map { flex: 1; min-height: 300px; background: #0a1628; }
</style>
</head>
<body>
  <div class="mission-control">
    <!-- Header -->
    <header class="header-bar">
      <div class="header-left">
        <div class="agency-logos">
          <div class="agency-logo" style="background:#0b3d91;color:#fff">NASA</div>
          <div class="agency-logo" style="background:#003399;color:#fff">ESA</div>
          <div class="agency-logo" style="background:#c41e3a;color:#fff">JAXA</div>
          <div class="agency-logo" style="background:#1e88e5;color:#fff">CSA</div>
          <div class="agency-logo" style="background:#0033a0;color:#fff">RSA</div>
        </div>
        <div class="mission-info">
          <h1>ISS EXPEDITION 72</h1>
          <div class="mission-subtitle">International Space Station ¬∑ Low Earth Orbit</div>
        </div>
      </div>
      <div class="header-center">
        <div class="orbit-badge" id="orbitBadge">üõ∞Ô∏è ORBIT ---</div>
      </div>
      <div class="header-right">
        <div class="current-time" id="utc">--:--:-- UTC</div>
      </div>
    </header>

    <main class="main-content">
      <!-- Map Panel -->
      <div class="map-container">
        <div class="map-header">
          <span class="map-title">üåç REAL-TIME ISS TRACKER</span>
          <div class="map-controls">
            <button class="map-btn active" id="btnFootprint" onclick="ISSTracker.toggleFootprint()">Footprint</button>
            <button class="map-btn active" id="btnTrack" onclick="ISSTracker.toggleTrack()">Track</button>
            <button class="map-btn" onclick="ISSTracker.centerOnISS()">Center ISS</button>
          </div>
        </div>
        <div id="iss-map"></div>
        <div class="data-overlay">
          <div class="data-row">
            <div class="data-item"><label>LATITUDE</label><span id="dataLat">--¬∞</span></div>
            <div class="data-item"><label>LONGITUDE</label><span id="dataLng">--¬∞</span></div>
          </div>
          <div class="data-row">
            <div class="data-item"><label>ALTITUDE</label><span id="dataAlt">-- km</span></div>
            <div class="data-item"><label>VELOCITY</label><span id="dataVel">-- km/h</span></div>
          </div>
        </div>
      </div>

      <!-- Station Systems Panel -->
      <div class="side-panel">
        <div class="panel-header">
          <span class="panel-title">‚ö° STATION SYSTEMS</span>
          <div class="live-badge"><span class="live-dot"></span>NASA LIVE</div>
        </div>
        
        <div class="station-viewer-dual">
          <!-- Dual 3D Views -->
          <div class="dual-view-container">
            <div class="iss-view" id="nadirView">
              <div class="view-label">NADIR VIEW</div>
              <canvas id="nadirCanvas"></canvas>
              <div class="axis-indicator">
                <span class="axis-z">‚ÜêTruss‚Üí</span> <span class="axis-x">‚ÜëVel</span>
              </div>
              <div class="loading-overlay" id="nadirLoading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading ISS Model...</div>
                <div class="loading-progress" id="nadirProgress">0%</div>
              </div>
            </div>
            
            <div class="iss-view" id="velocityView">
              <div class="view-label">VELOCITY VIEW</div>
              <canvas id="velocityCanvas"></canvas>
              <div class="axis-indicator">
                <span class="axis-z">‚ÜêTruss‚Üí</span> <span class="axis-y">‚ÜìNadir</span>
              </div>
              <div class="loading-overlay" id="velocityLoading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading ISS Model...</div>
                <div class="loading-progress" id="velocityProgress">0%</div>
              </div>
            </div>
          </div>
          
          <!-- Telemetry Grid Panel - 4x2 grid -->
          <div class="telemetry-grid-panel">
            <div class="telemetry-grid-header">
              <span>üìä STATION SYSTEMS TELEMETRY</span>
              <div class="live-badge" id="telemLiveBadge"><span class="live-dot"></span>LIVE</div>
            </div>
            <div class="telemetry-grid">
              <div class="telem-grid-item">
                <div class="telem-grid-label">DESTINY LAB</div>
                <div class="telem-grid-value" id="telTemp">--¬∞C</div>
                <div class="telem-grid-unit">temp</div>
              </div>
              <div class="telem-grid-item">
                <div class="telem-grid-label">HARMONY</div>
                <div class="telem-grid-value" id="telPressure">-- psia</div>
                <div class="telem-grid-unit">pressure</div>
              </div>
              <div class="telem-grid-item">
                <div class="telem-grid-label">COLUMBUS</div>
                <div class="telem-grid-value" id="telO2">-- mmHg</div>
                <div class="telem-grid-unit">O‚ÇÇ level</div>
              </div>
              <div class="telem-grid-item">
                <div class="telem-grid-label">KIBO (JEM)</div>
                <div class="telem-grid-value" id="telCO2">-- mmHg</div>
                <div class="telem-grid-unit">CO‚ÇÇ level</div>
              </div>
              <div class="telem-grid-item">
                <div class="telem-grid-label">ZVEZDA</div>
                <div class="telem-grid-value">--¬∞C</div>
                <div class="telem-grid-unit">temp</div>
              </div>
              <div class="telem-grid-item">
                <div class="telem-grid-label">ZARYA</div>
                <div class="telem-grid-value">--¬∞C</div>
                <div class="telem-grid-unit">temp</div>
              </div>
              <div class="telem-grid-item">
                <div class="telem-grid-label">ATTITUDE</div>
                <div class="telem-grid-value" id="attitudeDisplay">R:--¬∞ P:--¬∞</div>
                <div class="telem-grid-unit" id="attitudeYaw">Y:--¬∞</div>
              </div>
              <div class="telem-grid-item">
                <div class="telem-grid-label">SOLAR ARRAYS</div>
                <div class="telem-grid-value" id="telSolar">--¬∞</div>
                <div class="telem-grid-unit">Tracking Sun</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Timeline Bar -->
    <div class="timeline-bar">
      <div class="next-pass">
        <label>CURRENT POSITION OVER</label>
        <div class="time" id="overLocation">--</div>
        <div class="location" id="overCountry">Calculating...</div>
      </div>
      <div class="orbit-stats">
        <div class="stat-item">
          <div class="stat-value">16</div>
          <div class="stat-label">Orbits/Day</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statVel">--</div>
          <div class="stat-label">km/h</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statOrbit">---</div>
          <div class="stat-label">Total Orbits</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">25 yrs</div>
          <div class="stat-label">In Orbit</div>
        </div>
      </div>
    </div>

    <!-- News Ticker -->
    <div class="news-ticker">
      <div class="ticker-content">
        <div class="ticker-label">ISS UPDATE</div>
        <div class="ticker-item"><span class="ticker-time">12:30 UTC</span>Crew Dragon Endeavour docked at Harmony module ¬∑ Crew rotation complete</div>
        <div class="ticker-item"><span class="ticker-time">09:15 UTC</span>EVA scheduled for tomorrow ¬∑ Battery replacement on P4 truss</div>
        <div class="ticker-item"><span class="ticker-time">Yesterday</span>Cygnus cargo spacecraft departed ¬∑ Destructive reentry over Pacific</div>
        <div class="ticker-label">ISS UPDATE</div>
        <div class="ticker-item"><span class="ticker-time">12:30 UTC</span>Crew Dragon Endeavour docked at Harmony module ¬∑ Crew rotation complete</div>
        <div class="ticker-item"><span class="ticker-time">09:15 UTC</span>EVA scheduled for tomorrow ¬∑ Battery replacement on P4 truss</div>
      </div>
    </div>
  </div>


  <style>
    /* Data Overlay on Map */
    .data-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(10, 22, 40, 0.95);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 12px;
      z-index: 1000;
      min-width: 180px;
    }
    .data-row { display: flex; gap: 16px; margin-bottom: 6px; }
    .data-row:last-child { margin-bottom: 0; }
    .data-item label { 
      font-size: 0.5rem; 
      color: var(--text-secondary); 
      letter-spacing: 1px; 
      display: block; 
      margin-bottom: 2px; 
    }
    .data-item span { font-size: 0.95rem; color: var(--text-primary); }
    
    /* Side Panel */
    .side-panel {
      display: flex;
      flex-direction: column;
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: rgba(0, 188, 212, 0.1);
      border-bottom: 1px solid var(--border-color);
    }
    .panel-title {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--text-accent);
    }
    .live-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.5rem;
      color: var(--success-color);
    }
    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--success-color);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    /* Station Viewer - Dual 3D Layout */
    .station-viewer-dual {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: #000;
    }
    .dual-view-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      min-height: 0;
    }
    .iss-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: #000;
      min-width: 0;
    }
    .iss-view:first-child {
      border-right: 1px solid var(--border-color);
    }
    .view-label {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.6rem;
      color: var(--text-accent);
      background: rgba(0, 0, 0, 0.7);
      padding: 4px 10px;
      border-radius: 3px;
      z-index: 10;
      letter-spacing: 1px;
      border: 1px solid var(--border-color);
    }
    .iss-view canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    .axis-indicator {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 0.55rem;
      font-family: 'Courier New', monospace;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 3px;
    }
    .axis-x { color: #ff6b6b; }
    .axis-y { color: #51cf66; }
    .axis-z { color: #339af0; }
    
    /* Loading Overlay */
    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .loading-overlay.hidden { display: none; }
    .loading-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid rgba(0, 212, 255, 0.2);
      border-top-color: var(--text-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      margin-top: 10px;
      font-size: 0.55rem;
      color: var(--text-secondary);
    }
    .loading-progress {
      margin-top: 5px;
      font-size: 0.7rem;
      color: var(--text-accent);
    }

    
    /* Telemetry Grid Panel - 4x2 */
    .telemetry-grid-panel {
      height: 140px;
      min-height: 140px;
      background: rgba(13, 26, 45, 0.95);
      border-top: 1px solid var(--border-color);
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
    }
    .telemetry-grid-header {
      font-size: 0.55rem;
      color: var(--text-accent);
      letter-spacing: 1px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .telemetry-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 6px;
    }
    .telem-grid-item {
      background: rgba(0, 15, 30, 0.8);
      border: 1px solid rgba(26, 58, 92, 0.5);
      border-radius: 4px;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .telem-grid-item:hover {
      border-color: var(--text-accent);
      background: rgba(0, 212, 255, 0.05);
    }
    .telem-grid-label {
      font-size: 0.45rem;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }
    .telem-grid-value {
      font-size: 0.75rem;
      font-family: 'Courier New', monospace;
      color: var(--success-color);
      font-weight: 600;
    }
    .telem-grid-unit {
      font-size: 0.4rem;
      color: var(--text-secondary);
      margin-top: 1px;
    }
    
    /* Timeline Bar */
    .timeline-bar {
      background: var(--bg-panel);
      border-top: 1px solid var(--border-color);
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .next-pass label {
      font-size: 0.6rem;
      color: var(--text-secondary);
      letter-spacing: 1px;
    }
    .next-pass .time {
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      color: var(--iss-color);
    }
    .next-pass .location { font-size: 0.7rem; }
    .orbit-stats { display: flex; gap: 24px; }
    .stat-item { text-align: center; }
    .stat-value {
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
    }
    .stat-label {
      font-size: 0.55rem;
      color: var(--text-secondary);
    }
    
    /* News Ticker */
    .news-ticker {
      background: var(--bg-panel);
      border-top: 1px solid var(--border-color);
      padding: 6px 0;
      overflow: hidden;
    }
    .ticker-content {
      display: flex;
      animation: scroll 40s linear infinite;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .ticker-label {
      background: var(--iss-color);
      color: #000;
      padding: 2px 8px;
      font-size: 0.55rem;
      font-weight: 700;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .ticker-item {
      white-space: nowrap;
      margin-right: 30px;
      font-size: 0.7rem;
    }
    .ticker-time {
      color: var(--text-secondary);
      margin-right: 6px;
    }
    
    /* Leaflet Customizations */
    .leaflet-container { background: #0a1628 !important; }
    .leaflet-control-attribution {
      background: rgba(13, 26, 45, 0.8) !important;
      color: #8b949e !important;
      font-size: 10px !important;
    }
    .leaflet-control-attribution a { color: #00bcd4 !important; }
    .leaflet-control-zoom a {
      background: #0d1a2d !important;
      color: #00bcd4 !important;
      border-color: #1a3a5c !important;
    }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
      background: var(--bg-panel) !important;
      color: var(--text-primary) !important;
    }
  </style>


  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  
  <script type="module">
    // NASA Telemetry State
    let targetAttitude = { roll: 0, pitch: 0, yaw: 0 };
    let targetQuaternion = null;
    let currentQuaternion = null;
    let orbitCount = 142000; // Approximate ISS orbit count
    
    const nasaTelemetry = {
      cabinPressure: null,
      cabinTemp: null,
      o2Level: null,
      co2Level: null,
      solarArrayAngle: null,
      quaternion: { w: 1, x: 0, y: 0, z: 0 }
    };
    
    const TELEMETRY_ITEMS = [
      'NODE3000005', 'NODE3000004', 'USLAB000058', 'USLAB000059',
      'P1000004', 'USLAB000018', 'USLAB000019', 'USLAB000020', 'USLAB000021'
    ];
    
    // 3D View State
    let nadirScene, nadirCamera, nadirRenderer, issModelNadir;
    let velocityScene, velocityCamera, velocityRenderer, issModelVelocity;
    
    // ISS Tracker Module
    const ISSTracker = {
      map: null,
      issMarker: null,
      footprintCircle: null,
      groundTrack: null,
      positionHistory: [],
      showFootprint: true,
      showTrack: true,
      
      async init() {
        this.map = L.map('iss-map', {
          center: [20, 0],
          zoom: 2,
          minZoom: 1,
          maxZoom: 8,
          worldCopyJump: true
        });
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 19
        }).addTo(this.map);
        
        const issIcon = L.icon({
          iconUrl: '../assets/icons/spacecraft/big-iss-icon.png',
          iconSize: [80, 48],
          iconAnchor: [40, 24]
        });
        
        this.issMarker = L.marker([0, 0], { icon: issIcon }).addTo(this.map);
        
        this.footprintCircle = L.circle([0, 0], {
          radius: 2200000,
          color: '#00bcd4',
          fillColor: '#00bcd4',
          fillOpacity: 0.08,
          weight: 1.5,
          dashArray: '8, 4'
        }).addTo(this.map);
        
        this.groundTrack = L.polyline([], {
          color: '#ffd60a',
          weight: 2,
          opacity: 0.5,
          dashArray: '10, 6'
        }).addTo(this.map);
        
        await this.updatePosition();
        setInterval(() => this.updatePosition(), 5000);
      },
      
      async updatePosition() {
        try {
          const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
          const data = await response.json();
          
          const lat = data.latitude;
          const lng = data.longitude;
          
          this.issMarker.setLatLng([lat, lng]);
          
          if (this.footprintCircle && this.showFootprint) {
            this.footprintCircle.setLatLng([lat, lng]);
            this.footprintCircle.setRadius(data.footprint * 1000 / 2);
          }
          
          this.positionHistory.push([lat, lng]);
          if (this.positionHistory.length > 200) this.positionHistory.shift();
          if (this.groundTrack && this.showTrack) this.groundTrack.setLatLngs(this.positionHistory);
          
          document.getElementById('dataLat').textContent = lat.toFixed(2) + '¬∞' + (lat >= 0 ? 'N' : 'S');
          document.getElementById('dataLng').textContent = Math.abs(lng).toFixed(2) + '¬∞' + (lng >= 0 ? 'E' : 'W');
          document.getElementById('dataAlt').textContent = Math.round(data.altitude) + ' km';
          document.getElementById('dataVel').textContent = Math.round(data.velocity) + ' km/h';
          document.getElementById('statVel').textContent = Math.round(data.velocity);
          
          // Update location name
          this.updateLocationName(lat, lng);
          
          // Increment orbit count
          orbitCount += 0.0001;
          document.getElementById('statOrbit').textContent = Math.floor(orbitCount).toLocaleString();
          document.getElementById('orbitBadge').textContent = 'üõ∞Ô∏è ORBIT ' + Math.floor(orbitCount).toLocaleString();
          
        } catch (error) {
          console.error('Failed to fetch ISS position:', error);
        }
      },
      
      async updateLocationName(lat, lng) {
        try {
          const response = await fetch(`https://api.wheretheiss.at/v1/coordinates/${lat},${lng}`);
          const data = await response.json();
          if (data.timezone_id) {
            const parts = data.timezone_id.split('/');
            const location = parts[parts.length - 1].replace(/_/g, ' ');
            document.getElementById('overLocation').textContent = location;
            document.getElementById('overCountry').textContent = data.country_code || 'Ocean';
          } else {
            document.getElementById('overLocation').textContent = 'Ocean';
            document.getElementById('overCountry').textContent = 'International Waters';
          }
        } catch {
          document.getElementById('overLocation').textContent = lat.toFixed(1) + '¬∞, ' + lng.toFixed(1) + '¬∞';
          document.getElementById('overCountry').textContent = '';
        }
      },
      
      toggleFootprint() {
        this.showFootprint = !this.showFootprint;
        document.getElementById('btnFootprint').classList.toggle('active', this.showFootprint);
        if (this.showFootprint) this.footprintCircle.addTo(this.map);
        else this.footprintCircle.remove();
      },
      
      toggleTrack() {
        this.showTrack = !this.showTrack;
        document.getElementById('btnTrack').classList.toggle('active', this.showTrack);
        if (this.showTrack) this.groundTrack.addTo(this.map);
        else this.groundTrack.remove();
      },
      
      centerOnISS() {
        const pos = this.issMarker.getLatLng();
        this.map.setView(pos, 3, { animate: true });
      }
    };
    
    window.ISSTracker = ISSTracker;

    
    // Update time display
    function updateTime() {
      const now = new Date();
      const utc = now.toISOString().substr(11, 8);
      document.getElementById('utc').textContent = utc + ' UTC';
    }
    
    // NASA Lightstreamer Telemetry
    function initNASATelemetry() {
      try {
        const lsClient = new Ls.LightstreamerClient("https://push.lightstreamer.com", "ISSLIVE");
        lsClient.addListener({
          onStatusChange: function(status) {
            console.log("Lightstreamer status:", status);
          }
        });
        lsClient.connect();
        
        const subscription = new Ls.Subscription("MERGE", TELEMETRY_ITEMS, ["TimeStamp", "Value", "Status"]);
        subscription.setRequestedSnapshot("yes");
        subscription.addListener({
          onItemUpdate: function(update) { handleTelemetryUpdate(update); },
          onSubscription: function() { console.log("NASA telemetry subscription active"); }
        });
        lsClient.subscribe(subscription);
        console.log("NASA Lightstreamer telemetry initialized");
      } catch (error) {
        console.error("Failed to initialize NASA telemetry:", error);
      }
    }
    
    function handleTelemetryUpdate(update) {
      const itemName = update.getItemName();
      const value = update.getValue("Value");
      const status = update.getValue("Status");
      if (value === null || status === "stale") return;
      const numValue = parseFloat(value);
      
      switch(itemName) {
        case 'NODE3000005':
          nasaTelemetry.cabinPressure = numValue;
          document.getElementById('telPressure').textContent = numValue.toFixed(1) + ' psia';
          break;
        case 'NODE3000004':
          nasaTelemetry.cabinTemp = numValue;
          const tempC = ((numValue - 32) * 5/9).toFixed(1);
          document.getElementById('telTemp').textContent = tempC + '¬∞C';
          break;
        case 'USLAB000058':
          nasaTelemetry.o2Level = numValue;
          document.getElementById('telO2').textContent = numValue.toFixed(1) + ' mmHg';
          break;
        case 'USLAB000059':
          nasaTelemetry.co2Level = numValue;
          document.getElementById('telCO2').textContent = numValue.toFixed(2) + ' mmHg';
          break;
        case 'P1000004':
          nasaTelemetry.solarArrayAngle = numValue;
          document.getElementById('telSolar').textContent = Math.abs(numValue).toFixed(1) + '¬∞';
          break;
        case 'USLAB000018':
          nasaTelemetry.quaternion.w = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000019':
          nasaTelemetry.quaternion.x = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000020':
          nasaTelemetry.quaternion.y = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000021':
          nasaTelemetry.quaternion.z = numValue;
          updateAttitudeFromQuaternion();
          break;
      }
    }
    
    function quaternionToEuler(q) {
      const sinr_cosp = 2 * (q.w * q.x + q.y * q.z);
      const cosr_cosp = 1 - 2 * (q.x * q.x + q.y * q.y);
      const roll = Math.atan2(sinr_cosp, cosr_cosp) * (180 / Math.PI);
      const sinp = 2 * (q.w * q.y - q.z * q.x);
      let pitch = Math.abs(sinp) >= 1 ? Math.sign(sinp) * 90 : Math.asin(sinp) * (180 / Math.PI);
      const siny_cosp = 2 * (q.w * q.z + q.x * q.y);
      const cosy_cosp = 1 - 2 * (q.y * q.y + q.z * q.z);
      const yaw = Math.atan2(siny_cosp, cosy_cosp) * (180 / Math.PI);
      return { roll, pitch, yaw };
    }
    
    function updateAttitudeFromQuaternion() {
      const q = nasaTelemetry.quaternion;
      const magnitude = Math.sqrt(q.w*q.w + q.x*q.x + q.y*q.y + q.z*q.z);
      if (magnitude < 0.9 || magnitude > 1.1) return;
      
      const euler = quaternionToEuler(q);
      
      if (window.THREE) {
        if (!targetQuaternion) targetQuaternion = new window.THREE.Quaternion();
        targetQuaternion.set(q.x, q.y, q.z, q.w);
        targetQuaternion.normalize();
      }
      
      targetAttitude = euler;
      document.getElementById('attitudeDisplay').textContent = `R:${euler.roll.toFixed(1)}¬∞ P:${euler.pitch.toFixed(1)}¬∞`;
      document.getElementById('attitudeYaw').textContent = `Y:${euler.yaw.toFixed(1)}¬∞`;
    }

    
    // Dual 3D View System
    async function initDual3DISS() {
      const THREE = await import('three');
      const { GLTFLoader } = await import('three/addons/loaders/GLTFLoader.js');
      const { DRACOLoader } = await import('three/addons/loaders/DRACOLoader.js');
      
      window.THREE = THREE;
      
      setupDualView('nadir', THREE);
      setupDualView('velocity', THREE);
      await loadDualISSModel(THREE, GLTFLoader, DRACOLoader);
      animateDual3D();
      window.addEventListener('resize', onDualResize);
    }
    
    function setupDualView(viewName, THREE) {
      const canvas = document.getElementById(viewName + 'Canvas');
      const container = document.getElementById(viewName + 'View');
      if (!canvas || !container) return;
      
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);
      
      const aspect = container.clientWidth / container.clientHeight;
      const frustumSize = 80;
      const camera = new THREE.OrthographicCamera(
        -frustumSize * aspect / 2, frustumSize * aspect / 2,
        frustumSize / 2, -frustumSize / 2, 0.1, 1000
      );
      
      if (viewName === 'nadir') {
        camera.position.set(0, -100, 0);
        camera.up.set(1, 0, 0);
        camera.lookAt(0, 0, 0);
      } else {
        camera.position.set(100, 0, 0);
        camera.up.set(0, -1, 0);
        camera.lookAt(0, 0, 0);
      }
      
      const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
      directionalLight.position.set(50, 30, 50);
      scene.add(directionalLight);
      
      if (viewName === 'nadir') {
        nadirScene = scene; nadirCamera = camera; nadirRenderer = renderer;
      } else {
        velocityScene = scene; velocityCamera = camera; velocityRenderer = renderer;
      }
    }
    
    async function loadDualISSModel(THREE, GLTFLoader, DRACOLoader) {
      const dracoLoader = new DRACOLoader();
      dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/gltf/');
      const loader = new GLTFLoader();
      loader.setDRACOLoader(dracoLoader);
      
      return new Promise((resolve, reject) => {
        loader.load('../assets/iss-model-hd.glb',
          (gltf) => {
            const model = gltf.scene;
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            model.position.sub(center);
            const maxDim = Math.max(size.x, size.y, size.z);
            model.scale.setScalar(50 / maxDim);
            
            issModelNadir = model;
            issModelVelocity = model.clone();
            
            if (nadirScene) nadirScene.add(issModelNadir);
            if (velocityScene) velocityScene.add(issModelVelocity);
            
            document.getElementById('nadirLoading')?.classList.add('hidden');
            document.getElementById('velocityLoading')?.classList.add('hidden');
            resolve();
          },
          (progress) => {
            if (progress.total > 0) {
              const pct = Math.round((progress.loaded / progress.total) * 100);
              document.getElementById('nadirProgress')?.textContent && (document.getElementById('nadirProgress').textContent = pct + '%');
              document.getElementById('velocityProgress')?.textContent && (document.getElementById('velocityProgress').textContent = pct + '%');
            }
          },
          (error) => { console.error('Error loading ISS model:', error); reject(error); }
        );
      });
    }
    
    function animateDual3D() {
      requestAnimationFrame(animateDual3D);
      
      if (issModelNadir && issModelVelocity && window.THREE && targetQuaternion) {
        if (!currentQuaternion) currentQuaternion = targetQuaternion.clone();
        currentQuaternion.slerp(targetQuaternion, 0.05);
        issModelNadir.quaternion.copy(currentQuaternion);
        issModelVelocity.quaternion.copy(currentQuaternion);
      }
      
      if (nadirRenderer && nadirScene && nadirCamera) nadirRenderer.render(nadirScene, nadirCamera);
      if (velocityRenderer && velocityScene && velocityCamera) velocityRenderer.render(velocityScene, velocityCamera);
    }
    
    function onDualResize() {
      const frustumSize = 80;
      ['nadir', 'velocity'].forEach(viewName => {
        const container = document.getElementById(viewName + 'View');
        const camera = viewName === 'nadir' ? nadirCamera : velocityCamera;
        const renderer = viewName === 'nadir' ? nadirRenderer : velocityRenderer;
        if (camera && renderer && container) {
          const aspect = container.clientWidth / container.clientHeight;
          camera.left = -frustumSize * aspect / 2;
          camera.right = frustumSize * aspect / 2;
          camera.top = frustumSize / 2;
          camera.bottom = -frustumSize / 2;
          camera.updateProjectionMatrix();
          renderer.setSize(container.clientWidth, container.clientHeight);
        }
      });
    }
    
    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
      ISSTracker.init();
      initDual3DISS();
      initNASATelemetry();
      updateTime();
      setInterval(updateTime, 1000);
    });
  </script>
</body>
</html>
