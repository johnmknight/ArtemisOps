<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ISS Tracker Component</title>
  <!-- Import map for Three.js -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Lightstreamer for NASA telemetry -->
  <script src="https://unpkg.com/lightstreamer-client-web/lightstreamer.min.js" data-lightstreamer-ns="Ls"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0a1628;
      --bg-panel: #0d1a2d;
      --border-color: #1a3a5c;
      --text-primary: #ffffff;
      --text-secondary: #8b949e;
      --text-accent: #00bcd4;
      --iss-color: #00bcd4;
      --success-color: #7ed321;
      --accent-yellow: #ffd60a;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    
    .mission-control {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    /* Header */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 24px;
      background: linear-gradient(180deg, #0d1a2d 0%, #0a1628 100%);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    :fullscreen .header-bar,
    :-webkit-full-screen .header-bar {
      padding: 4px 16px;
    }
    :fullscreen .agency-logo,
    :-webkit-full-screen .agency-logo {
      width: 26px; height: 26px;
      font-size: 7px;
    }
    :fullscreen .mission-info h1,
    :-webkit-full-screen .mission-info h1 {
      font-size: 1.1rem;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .agency-logos { display: flex; gap: 6px; }
    .agency-logo {
      width: 32px; height: 32px; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      font-size: 8px; font-weight: bold;
    }
    .mission-info h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: 3px; }
    .mission-subtitle { font-size: 0.75rem; color: var(--iss-color); letter-spacing: 1px; }
    .header-center { display: flex; align-items: center; gap: 24px; }
    .orbit-badge {
      background: rgba(0, 188, 212, 0.2);
      border: 1px solid var(--iss-color);
      padding: 6px 14px; border-radius: 4px;
      font-size: 0.7rem; font-weight: 600;
      color: var(--iss-color); letter-spacing: 1px;
    }
    .current-time { font-family: 'Courier New', monospace; font-size: 0.9rem; color: var(--text-secondary); }
    
    /* Main Content - 3 Column Grid */
    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 50% 20% 30%;
      padding: 8px 12px;
      min-height: 0;
      gap: 10px;
    }
    
    /* Fullscreen optimizations */
    :fullscreen .main-content,
    :-webkit-full-screen .main-content {
      padding: 6px 10px;
      gap: 8px;
    }
    :fullscreen .header-bar,
    :-webkit-full-screen .header-bar {
      padding: 6px 16px;
    }
    :fullscreen .timeline-bar,
    :-webkit-full-screen .timeline-bar {
      padding: 6px 12px;
    }
    
    /* Map Container */
    .map-container {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      min-height: 0;
      height: 100%;
    }
    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(0, 188, 212, 0.1);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .map-title { font-size: 0.75rem; font-weight: 600; letter-spacing: 1px; color: var(--iss-color); }
    .map-controls { display: flex; gap: 8px; }
    .map-btn {
      background: rgba(0, 188, 212, 0.2);
      border: 1px solid var(--iss-color);
      color: var(--iss-color);
      padding: 4px 10px;
      font-size: 0.65rem;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .map-btn:hover { background: rgba(0, 188, 212, 0.3); }
    .map-btn.active { background: var(--iss-color); color: #000; }
    
    #iss-map { 
      flex: 1; 
      min-height: 0;
      background: #0a1628; 
    }
    
    /* Large Views Column (middle) */
    .large-views-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    .large-view-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    .large-view {
      flex: 1;
      position: relative;
      background: #000;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      overflow: hidden;
      min-height: 0;
    }
    .large-view canvas,
    .large-view iframe {
      width: 100%;
      height: 100%;
      display: block;
    }
    .large-view .view-label {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.65rem;
      color: var(--text-accent);
      background: rgba(0, 0, 0, 0.8);
      padding: 4px 10px;
      border-radius: 3px;
      z-index: 10;
      letter-spacing: 1px;
      border: 1px solid var(--border-color);
    }
    .large-view .axis-indicator {
      position: absolute;
      bottom: 8px;
      right: 10px;
      font-size: 0.55rem;
      font-family: 'Courier New', monospace;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 3px;
    }
    
    /* Small Views (in side panel) - 4:3 aspect ratio */
    .small-view-container {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }
    .small-view {
      flex: 1;
      position: relative;
      background: #000;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      overflow: hidden;
      aspect-ratio: 4 / 3;
    }
    .small-view canvas,
    .small-view iframe {
      width: 100%;
      height: 100%;
      display: block;
    }
    .view-label-small {
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 0.5rem;
      color: var(--text-accent);
      background: rgba(0, 0, 0, 0.8);
      padding: 2px 6px;
      border-radius: 2px;
      z-index: 10;
      letter-spacing: 0.5px;
    }

    /* ISS Marker with glow highlight */
    .iss-marker {
      background: transparent !important;
      border: none !important;
    }
    .iss-marker-container {
      position: relative;
      width: 80px;
      height: 48px;
    }
    .iss-marker-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      background: radial-gradient(circle at center, 
        rgba(0, 188, 212, 0.9) 0%, 
        rgba(0, 188, 212, 0.6) 20%, 
        rgba(0, 188, 212, 0.3) 40%, 
        rgba(0, 150, 180, 0.15) 60%,
        transparent 80%);
      border-radius: 50%;
      filter: blur(6px);
      animation: iss-glow-pulse 2s ease-in-out infinite;
    }
    .iss-marker-icon {
      position: absolute;
      top: 0;
      left: 0;
      width: 80px;
      height: 48px;
      filter: drop-shadow(0 0 6px rgba(0, 188, 212, 1)) drop-shadow(0 0 12px rgba(0, 188, 212, 0.6));
    }
    @keyframes iss-glow-pulse {
      0%, 100% { opacity: 0.85; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
    }
</style>
</head>
<body>
  <div class="mission-control">
    <!-- Header -->
    <header class="header-bar">
      <div class="header-left">
        <div class="agency-logos">
          <div class="agency-logo" style="background:#0b3d91;color:#fff">NASA</div>
          <div class="agency-logo" style="background:#003399;color:#fff">ESA</div>
          <div class="agency-logo" style="background:#c41e3a;color:#fff">JAXA</div>
          <div class="agency-logo" style="background:#1e88e5;color:#fff">CSA</div>
          <div class="agency-logo" style="background:#0033a0;color:#fff">RSA</div>
        </div>
        <div class="mission-info">
          <h1>ISS EXPEDITION 72</h1>
          <div class="mission-subtitle">International Space Station ¬∑ Low Earth Orbit</div>
        </div>
      </div>
      <div class="header-center">
        <div class="orbit-badge" id="orbitBadge">üõ∞Ô∏è ORBIT ---</div>
      </div>
      <div class="header-right">
        <div class="current-time" id="utc">--:--:-- UTC</div>
      </div>
    </header>

    <main class="main-content">
      <!-- Map Panel -->
      <div class="map-container">
        <div class="map-header">
          <span class="map-title">üåç REAL-TIME ISS TRACKER</span>
          <div class="map-controls">
            <button class="map-btn active" id="btnFootprint" onclick="ISSTracker.toggleFootprint()">Footprint</button>
            <button class="map-btn active" id="btnTrack" onclick="ISSTracker.toggleTrack()">Track</button>
            <button class="map-btn" onclick="ISSTracker.centerOnISS()">Center ISS</button>
          </div>
        </div>
        <div id="iss-map"></div>
      </div>

      <!-- Middle Column: Video Views (stacked) -->
      <div class="large-views-column">
        <div class="large-view-container">
          <div class="large-view">
            <div class="view-label">ISS LIVE 1</div>
            <iframe 
              id="issVideo1"
              src="https://www.youtube.com/embed/aB1yRz0HhdY?autoplay=1&mute=1"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen>
            </iframe>
          </div>
          <div class="large-view">
            <div class="view-label">ISS LIVE 2</div>
            <iframe 
              id="issVideo2"
              src="https://www.youtube.com/embed/FV4Q9DryTG8?autoplay=1&mute=1"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen>
            </iframe>
          </div>
        </div>
      </div>

      <!-- Right Column: 3D Views + Telemetry -->
      <div class="side-panel">
        <div class="panel-header">
          <span class="panel-title">üìç POSITION & ATTITUDE</span>
          <div class="live-badge"><span class="live-dot"></span>NASA LIVE</div>
        </div>
        
        <!-- 3D Views -->
        <div class="dual-view-container">
          <div class="iss-view" id="nadirView">
            <div class="view-label">NADIR</div>
            <canvas id="nadirCanvas"></canvas>
            <div class="axis-indicator">
              <span class="axis-z">‚ÜêT‚Üí</span> <span class="axis-x">‚ÜëV</span>
            </div>
            <div class="loading-overlay" id="nadirLoading">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading...</div>
              <div class="loading-progress" id="nadirProgress">0%</div>
            </div>
          </div>
          <div class="iss-view" id="velocityView">
            <div class="view-label">VELOCITY</div>
            <canvas id="velocityCanvas"></canvas>
            <div class="axis-indicator">
              <span class="axis-z">‚ÜêT‚Üí</span> <span class="axis-y">‚ÜìN</span>
            </div>
            <div class="loading-overlay" id="velocityLoading">
              <div class="loading-spinner"></div>
              <div class="loading-text">Loading...</div>
              <div class="loading-progress" id="velocityProgress">0%</div>
            </div>
          </div>
        </div>
        
        <div class="telemetry-sections">
          <!-- POSITION & TRAJECTORY -->
          <div class="telem-section">
            <div class="section-header">
              <span class="section-title">üåç POSITION & TRAJECTORY</span>
            </div>
            <div class="section-content">
              <div class="telem-grid-2col">
                <div class="telem-item highlight">
                  <div class="telem-label">LATITUDE</div>
                  <div class="telem-value large" id="telLat">--¬∞</div>
                </div>
                <div class="telem-item highlight">
                  <div class="telem-label">LONGITUDE</div>
                  <div class="telem-value large" id="telLng">--¬∞</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">ALTITUDE</div>
                  <div class="telem-value" id="telAlt">--</div>
                  <div class="telem-unit">km</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">RANGE</div>
                  <div class="telem-value dim" id="telRange">--</div>
                  <div class="telem-unit">km</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">APOGEE</div>
                  <div class="telem-value" id="telApogee">--</div>
                  <div class="telem-unit">km</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">PERIGEE</div>
                  <div class="telem-value" id="telPerigee">--</div>
                  <div class="telem-unit">km</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">INCLINATION</div>
                  <div class="telem-value" id="telInclination">51.64¬∞</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">PERIOD</div>
                  <div class="telem-value" id="telPeriod">92.8</div>
                  <div class="telem-unit">min</div>
                </div>
              </div>
              <!-- AOS/LOS Bar -->
              <div class="aos-los-bar">
                <div class="signal-status">
                  <div class="signal-dot" id="signalDot"></div>
                  <span id="signalLabel">--</span>
                </div>
                <div class="aos-time" id="aosLosTime">Next pass calculating...</div>
              </div>
            </div>
          </div>
          
          <!-- VELOCITY & ATTITUDE -->
          <div class="telem-section">
            <div class="section-header">
              <span class="section-title">üß≠ VELOCITY & ATTITUDE</span>
            </div>
            <div class="section-content">
              <!-- Velocity -->
              <div class="telem-grid-2col" style="margin-bottom: 8px;">
                <div class="telem-item wide highlight">
                  <div class="telem-label">VELOCITY</div>
                  <div class="telem-value large" id="telVelocity">--</div>
                  <div class="telem-unit">km/h (<span id="telVelKms">--</span> km/s)</div>
                </div>
              </div>
              
              <!-- Quaternion -->
              <div class="quaternion-display">
                <div class="quat-label">ATTITUDE QUATERNION (LVLH)</div>
                <div class="quat-values">
                  <div class="quat-item"><span>Q0</span><span id="quatQ0">--</span></div>
                  <div class="quat-item"><span>Q1</span><span id="quatQ1">--</span></div>
                  <div class="quat-item"><span>Q2</span><span id="quatQ2">--</span></div>
                  <div class="quat-item"><span>Q3</span><span id="quatQ3">--</span></div>
                </div>
              </div>
              
              <!-- Euler Angles -->
              <div class="telem-grid-3col">
                <div class="telem-item">
                  <div class="telem-label">ROLL</div>
                  <div class="telem-value" id="telRoll">--¬∞</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">PITCH</div>
                  <div class="telem-value" id="telPitch">--¬∞</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">YAW</div>
                  <div class="telem-value" id="telYaw">--¬∞</div>
                </div>
              </div>
              
              <!-- Attitude Errors -->
              <div class="telem-grid-3col" style="margin-top: 6px;">
                <div class="telem-item">
                  <div class="telem-label">ROLL ERR</div>
                  <div class="telem-value dim" id="telRollErr">--¬∞</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">PITCH ERR</div>
                  <div class="telem-value dim" id="telPitchErr">--¬∞</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">YAW ERR</div>
                  <div class="telem-value dim" id="telYawErr">--¬∞</div>
                </div>
              </div>
              
              <!-- Additional -->
              <div class="telem-grid-2col" style="margin-top: 6px;">
                <div class="telem-item">
                  <div class="telem-label">BETA ANGLE</div>
                  <div class="telem-value accent" id="telBeta">--¬∞</div>
                </div>
                <div class="telem-item">
                  <div class="telem-label">ISS MASS</div>
                  <div class="telem-value" id="telMass">--</div>
                  <div class="telem-unit">kg</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Timeline Bar -->
    <div class="timeline-bar">
      <div class="next-pass">
        <label>CURRENT POSITION OVER</label>
        <div class="time" id="overLocation">--</div>
        <div class="location" id="overCountry">Calculating...</div>
      </div>
      <div class="orbit-stats">
        <div class="stat-item">
          <div class="stat-value">16</div>
          <div class="stat-label">Orbits/Day</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statVel">--</div>
          <div class="stat-label">km/h</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statOrbit">---</div>
          <div class="stat-label">Total Orbits</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">25 yrs</div>
          <div class="stat-label">In Orbit</div>
        </div>
      </div>
    </div>

    <!-- News Ticker -->
    <div class="news-ticker">
      <div class="ticker-content" id="tickerContent">
        <div class="ticker-label">ISS UPDATE</div>
        <div class="ticker-item"><span class="ticker-time">Loading...</span>Fetching latest ISS news...</div>
      </div>
    </div>
  </div>

  <script>
    // News Ticker - Fetch live ISS news
    async function loadISSNews() {
      const tickerContent = document.getElementById('tickerContent');
      if (!tickerContent) return;
      
      try {
        const response = await fetch('/api/iss/news?limit=8');
        if (!response.ok) throw new Error('News fetch failed');
        
        const data = await response.json();
        
        if (data.news && data.news.length > 0) {
          // Build ticker HTML
          let html = '<div class="ticker-label">ISS UPDATE</div>';
          
          data.news.forEach(item => {
            const time = item.time_ago || '';
            const title = item.title || 'ISS Update';
            html += `<div class="ticker-item"><span class="ticker-time">${time}</span>${title}</div>`;
          });
          
          // Duplicate for seamless scrolling
          html += '<div class="ticker-label">ISS UPDATE</div>';
          data.news.forEach(item => {
            const time = item.time_ago || '';
            const title = item.title || 'ISS Update';
            html += `<div class="ticker-item"><span class="ticker-time">${time}</span>${title}</div>`;
          });
          
          tickerContent.innerHTML = html;
        }
      } catch (error) {
        console.error('Failed to load ISS news:', error);
        tickerContent.innerHTML = '<div class="ticker-label">ISS UPDATE</div><div class="ticker-item"><span class="ticker-time">--</span>News feed temporarily unavailable</div>';
      }
    }
    
    // Load news on page load and refresh every 15 minutes
    loadISSNews();
    setInterval(loadISSNews, 15 * 60 * 1000);
  </script>


  <style>
    /* Data Overlay on Map */
    .data-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(10, 22, 40, 0.95);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 12px;
      z-index: 1000;
      min-width: 180px;
    }
    .data-row { display: flex; gap: 16px; margin-bottom: 6px; }
    .data-row:last-child { margin-bottom: 0; }
    .data-item label { 
      font-size: 0.5rem; 
      color: var(--text-secondary); 
      letter-spacing: 1px; 
      display: block; 
      margin-bottom: 2px; 
    }
    .data-item span { font-size: 0.95rem; color: var(--text-primary); }
    
    /* Side Panel */
    .side-panel {
      display: flex;
      flex-direction: column;
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      overflow: hidden;
      min-height: 0;
      height: 100%;
    }
    :fullscreen .side-panel,
    :-webkit-full-screen .side-panel {
      max-width: 380px;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(0, 188, 212, 0.1);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    :fullscreen .panel-header,
    :-webkit-full-screen .panel-header {
      padding: 6px 10px;
    }
    .panel-title {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--text-accent);
    }
    .live-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.5rem;
      color: var(--success-color);
    }
    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--success-color);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    /* View Toggle Buttons */
    .view-toggle {
      display: flex;
      gap: 4px;
    }
    .toggle-btn {
      background: rgba(0, 188, 212, 0.1);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 4px 10px;
      font-size: 0.55rem;
      font-family: 'Courier New', monospace;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .toggle-btn:hover {
      border-color: var(--iss-color);
      color: var(--text-primary);
    }
    .toggle-btn.active {
      background: rgba(0, 188, 212, 0.3);
      border-color: var(--iss-color);
      color: var(--text-accent);
    }
    
    /* Video Views */
    .video-view {
      flex: 1;
      position: relative;
      background: #000;
      min-width: 0;
    }
    .video-view:first-child {
      border-right: 2px solid var(--iss-color);
    }
    .video-view iframe {
      width: 100%;
      height: 100%;
      display: block;
    }
    .video-view .view-label {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.6rem;
      color: var(--text-accent);
      background: rgba(0, 0, 0, 0.8);
      padding: 4px 10px;
      border-radius: 3px;
      z-index: 10;
      letter-spacing: 1px;
      border: 1px solid var(--border-color);
    }
    
    /* Hidden class */
    .hidden {
      display: none !important;
    }
    
    /* 3D Views Layout */
    .dual-view-container {
      height: 120px;
      min-height: 120px;
      display: flex;
      flex-direction: row;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .iss-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: #000;
      min-width: 0;
    }
    .iss-view:first-child {
      border-right: 2px solid var(--iss-color);
    }
    .view-label {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.6rem;
      color: var(--text-accent);
      background: rgba(0, 0, 0, 0.7);
      padding: 4px 10px;
      border-radius: 3px;
      z-index: 10;
      letter-spacing: 1px;
      border: 1px solid var(--border-color);
    }
    .iss-view canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    .axis-indicator {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 0.55rem;
      font-family: 'Courier New', monospace;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 3px;
    }
    .axis-x { color: #ff6b6b; }
    .axis-y { color: #51cf66; }
    .axis-z { color: #339af0; }
    
    /* Loading Overlay */
    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .loading-overlay.hidden { display: none; }
    .loading-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid rgba(0, 212, 255, 0.2);
      border-top-color: var(--text-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      margin-top: 10px;
      font-size: 0.55rem;
      color: var(--text-secondary);
    }
    .loading-progress {
      margin-top: 5px;
      font-size: 0.7rem;
      color: var(--text-accent);
    }

    
    /* Telemetry Grid Panel - 4x4 */
    .telemetry-grid-panel {
      height: 200px;
      min-height: 200px;
      background: rgba(13, 26, 45, 0.95);
      border-top: 1px solid var(--border-color);
      padding: 6px 10px;
      display: flex;
      flex-direction: column;
    }
    .telemetry-grid-header {
      font-size: 0.55rem;
      color: var(--text-accent);
      letter-spacing: 1px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .telemetry-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 4px;
    }
    .telem-grid-item {
      background: rgba(0, 15, 30, 0.8);
      border: 1px solid rgba(26, 58, 92, 0.5);
      border-radius: 3px;
      padding: 4px 6px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .telem-grid-item:hover {
      border-color: var(--text-accent);
      background: rgba(0, 212, 255, 0.05);
    }
    .telem-grid-item.solar-array {
      background: rgba(20, 40, 10, 0.6);
      border-color: rgba(126, 211, 33, 0.3);
    }
    .telem-grid-item.solar-array:hover {
      border-color: var(--success-color);
    }
    .telem-grid-label {
      font-size: 0.4rem;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
      margin-bottom: 1px;
    }
    .telem-grid-value {
      font-size: 0.65rem;
      font-family: 'Courier New', monospace;
      color: var(--success-color);
      font-weight: 600;
    }
    .telem-grid-unit {
      font-size: 0.35rem;
      color: var(--text-secondary);
      margin-top: 0px;
    }
    
    /* NEW: Position & Attitude Telemetry Sections */
    .telemetry-sections {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 4px;
      min-height: 0;
    }
    .telem-section {
      background: rgba(0, 15, 30, 0.5);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .section-header {
      padding: 3px 6px;
      background: rgba(0, 188, 212, 0.1);
      border-bottom: 1px solid var(--border-color);
    }
    .section-title {
      font-size: 0.5rem;
      color: var(--text-accent);
      letter-spacing: 0.5px;
    }
    .section-content {
      padding: 4px;
      flex: 1;
    }
    
    /* Telemetry Grid Layouts */
    .telem-grid-2col {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 3px;
    }
    .telem-grid-3col {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
    }
    .telem-item {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 2px;
      padding: 3px 4px;
      text-align: center;
    }
    .telem-item.wide { grid-column: span 2; }
    .telem-item.highlight {
      border-color: var(--iss-color);
      background: rgba(0, 188, 212, 0.1);
    }
    .telem-label {
      font-size: 0.4rem;
      color: var(--text-secondary);
      letter-spacing: 0.3px;
      margin-bottom: 1px;
    }
    .telem-value {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
    }
    .telem-value.large { font-size: 0.85rem; }
    .telem-value.accent { color: var(--text-accent); }
    .telem-value.dim { opacity: 0.4; }
    .telem-unit {
      font-size: 0.35rem;
      color: var(--text-secondary);
      margin-top: 0px;
    }
    
    /* AOS/LOS Bar */
    .aos-los-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 4px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 2px;
      margin-top: 3px;
    }
    .signal-status {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 0.5rem;
    }
    .signal-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-secondary);
    }
    .signal-dot.aos { background: var(--success-color); }
    .signal-dot.los { background: var(--text-secondary); }
    .aos-time {
      flex: 1;
      text-align: right;
      font-size: 0.55rem;
      color: var(--text-accent);
    }
    
    /* Quaternion Display */
    .quaternion-display {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 2px;
      padding: 3px 4px;
      margin-bottom: 3px;
    }
    .quat-label {
      font-size: 0.4rem;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }
    .quat-values {
      display: flex;
      justify-content: space-between;
    }
    .quat-item {
      text-align: center;
    }
    .quat-item span:first-child {
      display: block;
      font-size: 0.35rem;
      color: var(--text-secondary);
    }
    .quat-item span:last-child {
      font-size: 0.6rem;
      color: var(--text-accent);
      font-family: 'Courier New', monospace;
    }

    /* Video Panel */
    .video-panel {
      display: flex;
      flex-direction: column;
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }
    .video-stack {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: var(--border-color);
      min-height: 0;
    }
    .video-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #000;
      min-height: 0;
    }
    .video-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 10px;
      background: rgba(0, 188, 212, 0.1);
      border-bottom: 1px solid var(--border-color);
    }
    .video-title {
      font-size: 0.6rem;
      color: var(--text-accent);
      letter-spacing: 0.5px;
    }
    .video-controls {
      display: flex;
      gap: 4px;
    }
    .video-btn {
      background: rgba(0, 188, 212, 0.2);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 2px 6px;
      font-size: 0.6rem;
      border-radius: 3px;
      cursor: pointer;
    }
    .video-btn:hover {
      background: rgba(0, 188, 212, 0.4);
      border-color: var(--iss-color);
    }
    .video-wrapper {
      flex: 1;
      position: relative;
      min-height: 0;
    }
    .video-wrapper iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* Timeline Bar */
    .timeline-bar {
      background: var(--bg-panel);
      border-top: 1px solid var(--border-color);
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    :fullscreen .timeline-bar,
    :-webkit-full-screen .timeline-bar {
      padding: 6px 12px;
    }
    :fullscreen .next-pass .time,
    :-webkit-full-screen .next-pass .time {
      font-size: 0.85rem;
    }
    :fullscreen .stat-value,
    :-webkit-full-screen .stat-value {
      font-size: 0.8rem;
    }
    .next-pass label {
      font-size: 0.6rem;
      color: var(--text-secondary);
      letter-spacing: 1px;
    }
    .next-pass .time {
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      color: var(--iss-color);
    }
    .next-pass .location { font-size: 0.7rem; }
    .orbit-stats { display: flex; gap: 24px; }
    .stat-item { text-align: center; }
    .stat-value {
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
    }
    .stat-label {
      font-size: 0.55rem;
      color: var(--text-secondary);
    }
    
    /* News Ticker */
    .news-ticker {
      background: var(--bg-panel);
      border-top: 1px solid var(--border-color);
      padding: 6px 0;
      overflow: hidden;
      flex-shrink: 0;
    }
    :fullscreen .news-ticker,
    :-webkit-full-screen .news-ticker {
      padding: 4px 0;
    }
    :fullscreen .ticker-item,
    :-webkit-full-screen .ticker-item {
      font-size: 0.6rem;
    }
    .ticker-content {
      display: flex;
      animation: scroll 40s linear infinite;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .ticker-label {
      background: var(--iss-color);
      color: #000;
      padding: 2px 8px;
      font-size: 0.55rem;
      font-weight: 700;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .ticker-item {
      white-space: nowrap;
      margin-right: 30px;
      font-size: 0.7rem;
    }
    .ticker-time {
      color: var(--text-secondary);
      margin-right: 6px;
    }
    
    /* Leaflet Customizations */
    .leaflet-container { background: #0a1628 !important; }
    .leaflet-control-attribution {
      background: rgba(13, 26, 45, 0.8) !important;
      color: #8b949e !important;
      font-size: 10px !important;
    }
    .leaflet-control-attribution a { color: #00bcd4 !important; }
    .leaflet-control-zoom a {
      background: #0d1a2d !important;
      color: #00bcd4 !important;
      border-color: #1a3a5c !important;
    }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip {
      background: var(--bg-panel) !important;
      color: var(--text-primary) !important;
    }
  </style>


  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  
  <script type="module">
    // Video mute toggle
    window.toggleMute = function(playerId) {
      const iframe = document.getElementById(playerId);
      const btn = document.getElementById(playerId === 'nasaTvPlayer' ? 'btnNasaTvMute' : 'btnIssHdMute');
      if (!iframe) return;
      
      const src = iframe.src;
      if (src.includes('mute=1')) {
        iframe.src = src.replace('mute=1', 'mute=0');
        btn.textContent = 'üîä';
      } else {
        iframe.src = src.replace('mute=0', 'mute=1');
        btn.textContent = 'üîá';
      }
    };

    // NASA Telemetry State
    let targetAttitude = { roll: 0, pitch: 0, yaw: 0 };
    let targetQuaternion = null;
    let currentQuaternion = null;
    let orbitCount = 142000; // Approximate ISS orbit count
    
    const nasaTelemetry = {
      // Environmental
      cabinPressure: null,
      cabinTemp: null,
      o2Level: null,
      co2Level: null,
      // Life Support (Node 3)
      ogsState: null,
      urineTank: null,
      wpaState: null,
      cleanWater: null,
      // Power/Attitude
      cmgMomentum: null,
      betaAngle: null,
      issMass: null,
      quaternion: { w: 1, x: 0, y: 0, z: 0 },
      // Solar Arrays
      sarjPort: null,
      sarjStbd: null,
      bgaPort2A: null,
      bgaPort4A: null,
      bgaStbd1A: null,
      bgaStbd3A: null
    };
    
    // Expanded telemetry items - organized by system
    const TELEMETRY_ITEMS = [
      // Environmental (US Lab)
      'USLAB000058',  // Cabin Pressure [psia]
      'USLAB000059',  // Cabin Temp [¬∞F]
      'USLAB000053',  // ppO2 [mmHg]
      'USLAB000055',  // ppCO2 [mmHg]
      // Life Support (Node 3 / Tranquility)
      'NODE3000010',  // O2 Generator State
      'NODE3000005',  // Urine Tank [%]
      'NODE3000006',  // Water Processor State
      'NODE3000009',  // Clean Water Tank [%]
      // Power/Attitude
      'USLAB000010',  // CMG Momentum [%]
      'USLAB000040',  // Solar Beta Angle [¬∞]
      'USLAB000039',  // ISS Total Mass [kg]
      // Attitude Quaternion
      'USLAB000018', 'USLAB000019', 'USLAB000020', 'USLAB000021',
      // Solar Array Rotary Joints (SARJ) - Alpha rotation
      'S0000004',     // Port SARJ Angle [¬∞]
      'S0000003',     // Starboard SARJ Angle [¬∞]
      // Beta Gimbal Assemblies (BGA) - Solar panel tilt
      'P4000007',     // Port 2A BGA [¬∞]
      'P4000008',     // Port 4A BGA [¬∞]
      'S4000007',     // Starboard 1A BGA [¬∞]
      'S4000008'      // Starboard 3A BGA [¬∞]
    ];
    
    // 3D View State
    let nadirScene, nadirCamera, nadirRenderer, issModelNadir;
    let velocityScene, velocityCamera, velocityRenderer, issModelVelocity;
    
    // ISS Orbital Constants
    const ISS_ORBITAL_PERIOD_MS = 92.68 * 60 * 1000; // ~92.68 minutes in ms
    const ISS_GROUND_SPEED_DEG_PER_SEC = 360 / (92.68 * 60); // degrees longitude per second
    const TRACK_CACHE_KEY = 'artemisops_iss_ground_track';
    const MAX_TRACK_POINTS = 1200; // ~1 full orbit (93 min √ó 12 updates/min = 1116 points)
    
    /*
     * Ground Track Caching Strategy:
     * - Gap < 10 seconds: Use cached data directly
     * - Gap 10s to 30 min: Extrapolate missing points using linear projection
     * - Gap > 30 min (half orbit): Clear cache - old positions are stale/wrong
     * - Gap > 3 hours (2 orbits): Cache auto-expires
     * 
     * Linear extrapolation works for short gaps because ISS follows predictable
     * sinusoidal ground track. For longer gaps, positions become unreliable.
     */
    
    // ISS Tracker Module
    const ISSTracker = {
      map: null,
      issMarker: null,
      footprintCircle: null,
      groundTrack: null,
      positionHistory: [],
      showFootprint: true,
      showTrack: true,
      lastUpdateTime: null,
      
      // Load cached ground track from localStorage
      loadCachedTrack() {
        try {
          const cached = localStorage.getItem(TRACK_CACHE_KEY);
          if (!cached) return [];
          
          const data = JSON.parse(cached);
          const now = Date.now();
          const age = now - data.timestamp;
          
          // If cache is older than 3 orbits, discard completely
          if (age > ISS_ORBITAL_PERIOD_MS * 3) {
            console.log('Ground track cache too old (>3 orbits), discarding');
            localStorage.removeItem(TRACK_CACHE_KEY);
            return [];
          }
          
          console.log(`Loaded ${data.positions.length} cached track points, age: ${(age/60000).toFixed(1)} min`);
          
          // If there's a gap, try to extrapolate (up to 30 min worth)
          if (age > 10000 && data.positions.length >= 2) {
            const extrapolated = this.extrapolateTrack(data.positions, data.timestamp, now);
            return extrapolated;
          }
          
          return data.positions;
        } catch (e) {
          console.error('Error loading cached track:', e);
          return [];
        }
      },
      
      // Extrapolate missing track points based on orbital mechanics
      // Only called for gaps < 30 minutes where linear extrapolation is reasonable
      extrapolateTrack(positions, lastTime, currentTime) {
        if (positions.length < 2) return positions;
        
        const gapSeconds = (currentTime - lastTime) / 1000;
        
        // Get last two points to determine heading
        const p1 = positions[positions.length - 2];
        const p2 = positions[positions.length - 1];
        
        // Calculate velocity vector (degrees per second)
        const dt = 5; // Assumed 5 second interval between cached points
        const dLat = (p2[0] - p1[0]) / dt;
        const dLng = (p2[1] - p1[1]) / dt;
        
        // Extrapolate new points every 5 seconds
        const extrapolatedPoints = [...positions];
        const numPoints = Math.min(Math.floor(gapSeconds / 5), 360); // Cap at 30 min worth
        
        console.log(`Extrapolating ${numPoints} points over ${(gapSeconds/60).toFixed(1)} min gap`);
        
        let lat = p2[0];
        let lng = p2[1];
        
        for (let i = 1; i <= numPoints; i++) {
          // Simple linear extrapolation with latitude bounds (ISS inclination ~51.6¬∞)
          lat += dLat * 5;
          lng += dLng * 5;
          
          // Wrap longitude
          if (lng > 180) lng -= 360;
          if (lng < -180) lng += 360;
          
          // Bound latitude to ISS inclination and reverse direction at bounds
          if (lat > 51.6) { lat = 51.6 - (lat - 51.6); }
          if (lat < -51.6) { lat = -51.6 - (lat + 51.6); }
          
          extrapolatedPoints.push([lat, lng]);
        }
        
        // Trim to max points
        if (extrapolatedPoints.length > MAX_TRACK_POINTS) {
          extrapolatedPoints.splice(0, extrapolatedPoints.length - MAX_TRACK_POINTS);
        }
        
        return extrapolatedPoints;
      },
      
      // Save ground track to localStorage
      saveTrackCache() {
        try {
          if (this.positionHistory.length < 2) return;
          
          const data = {
            timestamp: Date.now(),
            positions: this.positionHistory.slice(-MAX_TRACK_POINTS)
          };
          localStorage.setItem(TRACK_CACHE_KEY, JSON.stringify(data));
        } catch (e) {
          console.error('Error saving track cache:', e);
        }
      },
      
      // Split track into segments at antimeridian crossings (180¬∞/-180¬∞)
      // This prevents Leaflet from drawing lines across the entire map
      splitTrackAtAntimeridian(positions) {
        if (!positions || positions.length < 2) return [];
        
        const segments = [];
        let currentSegment = [positions[0]];
        
        for (let i = 1; i < positions.length; i++) {
          const prevLng = positions[i - 1][1];
          const currLng = positions[i][1];
          
          // Check for antimeridian crossing (longitude jump > 180¬∞)
          const lngDiff = Math.abs(currLng - prevLng);
          if (lngDiff > 180) {
            // End current segment and start new one
            if (currentSegment.length >= 1) {
              segments.push(currentSegment);
            }
            currentSegment = [positions[i]];
          } else {
            currentSegment.push(positions[i]);
          }
        }
        
        // Add final segment
        if (currentSegment.length >= 1) {
          segments.push(currentSegment);
        }
        
        return segments;
      },
      
      // Calculate sun position (subsolar point)
      getSunPosition(date = new Date()) {
        const rad = Math.PI / 180;
        const deg = 180 / Math.PI;
        
        // Days since J2000.0 epoch
        const jd = date.getTime() / 86400000 + 2440587.5;
        const n = jd - 2451545.0;
        
        // Mean longitude and anomaly of the Sun
        const L = (280.460 + 0.9856474 * n) % 360;
        const g = (357.528 + 0.9856003 * n) % 360;
        
        // Ecliptic longitude of the Sun
        const lambda = L + 1.915 * Math.sin(g * rad) + 0.020 * Math.sin(2 * g * rad);
        
        // Obliquity of the ecliptic
        const epsilon = 23.439 - 0.0000004 * n;
        
        // Sun's declination
        const sunDec = Math.asin(Math.sin(epsilon * rad) * Math.sin(lambda * rad)) * deg;
        
        // Equation of time (approximate)
        const eot = -1.915 * Math.sin(g * rad) - 0.020 * Math.sin(2 * g * rad) 
                    + 2.466 * Math.sin(2 * lambda * rad) - 0.053 * Math.sin(4 * lambda * rad);
        
        // Solar noon in UTC
        const utcHours = date.getUTCHours() + date.getUTCMinutes() / 60 + date.getUTCSeconds() / 3600;
        const sunLng = -15 * (utcHours - 12 + eot / 60);
        
        return { lat: sunDec, lng: ((sunLng + 540) % 360) - 180 };
      },
      
      // Generate terminator polygon points
      getTerminatorCoords(sunPos) {
        const rad = Math.PI / 180;
        const coords = [];
        
        // Generate points along the terminator
        for (let i = 0; i <= 360; i += 2) {
          const lng = -180 + i;
          
          // Calculate latitude of terminator at this longitude
          const hourAngle = (lng - sunPos.lng) * rad;
          const lat = Math.atan(-Math.cos(hourAngle) / Math.tan(sunPos.lat * rad)) * 180 / Math.PI;
          
          coords.push([lat, lng]);
        }
        
        return coords;
      },
      
      // Create the night polygon
      createTerminator() {
        const sunPos = this.getSunPosition();
        const rad = Math.PI / 180;
        const nightCoords = [];
        
        // Generate terminator line points
        for (let i = 0; i <= 360; i += 2) {
          const lng = -180 + i;
          const hourAngle = (lng - sunPos.lng) * rad;
          
          // Handle edge cases near poles
          if (Math.abs(sunPos.lat) < 0.1) {
            // Near equinox, terminator is nearly vertical
            nightCoords.push([0, lng]);
          } else {
            const tanLat = -Math.cos(hourAngle) / Math.tan(sunPos.lat * rad);
            const lat = Math.atan(tanLat) * 180 / Math.PI;
            nightCoords.push([lat, lng]);
          }
        }
        
        // Close the polygon toward the pole opposite the sun
        // Night is on the side away from the sun
        const nightPole = sunPos.lat > 0 ? -90 : 90;
        
        // Add pole corners to complete the night polygon
        nightCoords.push([nightPole, 180]);
        nightCoords.push([nightPole, -180]);
        
        return L.polygon(nightCoords, {
          color: '#1a3a5c',
          weight: 1,
          fillColor: '#000011',
          fillOpacity: 0.45,
          interactive: false
        });
      },
      
      // Update terminator position
      updateTerminator() {
        if (this.terminatorLayer) {
          this.map.removeLayer(this.terminatorLayer);
        }
        this.terminatorLayer = this.createTerminator();
        this.terminatorLayer.addTo(this.map);
      },
      
      async init() {
        // Load cached ground track from previous session
        this.positionHistory = this.loadCachedTrack();
        console.log(`Starting with ${this.positionHistory.length} cached track points`);
        
        // EPSG:4326 Equirectangular projection (NASA Mission Control style)
        this.map = L.map('iss-map', {
          crs: L.CRS.EPSG4326,
          center: [0, 0],
          zoom: 1,
          minZoom: 0,
          maxZoom: 5,
          zoomSnap: 0,
          zoomDelta: 0.5,
          maxBounds: [[-90, -180], [90, 180]],
          maxBoundsViscosity: 1.0,
          worldCopyJump: false
        });
        
        // Fit to container
        this.map.fitBounds([[-90, -180], [90, 180]]);
        
        // NASA GIBS Blue Marble tiles in EPSG:4326 (WMS)
        L.tileLayer.wms('https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi', {
          layers: 'BlueMarble_ShadedRelief_Bathymetry',
          format: 'image/jpeg',
          transparent: false,
          attribution: '&copy; NASA GIBS Blue Marble',
          crs: L.CRS.EPSG4326,
          noWrap: true,
          bounds: [[-90, -180], [90, 180]]
        }).addTo(this.map);
        
        const issIcon = L.divIcon({
          className: 'iss-marker',
          html: `
            <div class="iss-marker-container">
              <div class="iss-marker-glow"></div>
              <img class="iss-marker-icon" src="../assets/icons/spacecraft/big-iss-icon.png" alt="ISS">
            </div>
          `,
          iconSize: [80, 48],
          iconAnchor: [40, 24]
        });
        
        this.issMarker = L.marker([0, 0], { icon: issIcon }).addTo(this.map);
        
        this.footprintCircle = L.circle([0, 0], {
          radius: 2200000,
          color: '#00bcd4',
          fillColor: '#00bcd4',
          fillOpacity: 0.08,
          weight: 1.5,
          dashArray: '8, 4'
        }).addTo(this.map);
        
        // Ground track - initialize with cached positions (split at antimeridian)
        const initialSegments = this.splitTrackAtAntimeridian(this.positionHistory);
        this.groundTrack = L.polyline(initialSegments, {
          color: '#ffd60a',
          weight: 3,
          opacity: 0.8,
          dashArray: '10, 6'
        }).addTo(this.map);
        
        // Day/Night Terminator
        this.terminatorLayer = this.createTerminator();
        this.terminatorLayer.addTo(this.map);
        
        // Update terminator every minute
        setInterval(() => this.updateTerminator(), 60000);
        
        await this.updatePosition();
        setInterval(() => this.updatePosition(), 5000);
        
        // Handle fullscreen changes - resize map
        const self = this;
        document.addEventListener('fullscreenchange', function() {
          setTimeout(() => {
            self.map.invalidateSize();
            self.map.fitBounds([[-90, -180], [90, 180]]);
          }, 100);
        });
        document.addEventListener('webkitfullscreenchange', function() {
          setTimeout(() => {
            self.map.invalidateSize();
            self.map.fitBounds([[-90, -180], [90, 180]]);
          }, 100);
        });
      },
      
      async updatePosition() {
        try {
          // Try server proxy first, fallback to direct API
          let data;
          try {
            const response = await fetch('/api/iss/position');
            if (response.ok) {
              data = await response.json();
              data.latitude = data.latitude || data.lat;
              data.longitude = data.longitude || data.lng;
              data.altitude = data.altitude_km || data.altitude;
              data.velocity = data.velocity_kmh || data.velocity;
              data.footprint = data.footprint_km || data.footprint || 4400;
            } else {
              throw new Error('Proxy unavailable');
            }
          } catch {
            // Fallback to direct API
            const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
            data = await response.json();
          }
          
          const lat = data.latitude;
          const lng = data.longitude;
          
          this.issMarker.setLatLng([lat, lng]);
          
          if (this.footprintCircle) {
            this.footprintCircle.setLatLng([lat, lng]);
            this.footprintCircle.setRadius((data.footprint || 4400) * 1000 / 2);
            if (!this.showFootprint) this.footprintCircle.remove();
          }
          
          // Update ground track
          this.positionHistory.push([lat, lng]);
          if (this.positionHistory.length > MAX_TRACK_POINTS) this.positionHistory.shift();
          if (this.groundTrack) {
            // Split track at antimeridian crossings to prevent lines across map
            const segments = this.splitTrackAtAntimeridian(this.positionHistory);
            this.groundTrack.setLatLngs(segments);
            if (!this.showTrack) this.groundTrack.remove();
          }
          
          // Save track to cache every update
          this.saveTrackCache();
          
          document.getElementById('telLat').textContent = lat.toFixed(2) + '¬∞' + (lat >= 0 ? 'N' : 'S');
          document.getElementById('telLng').textContent = Math.abs(lng).toFixed(2) + '¬∞' + (lng >= 0 ? 'E' : 'W');
          document.getElementById('telAlt').textContent = Math.round(data.altitude);
          document.getElementById('telVelocity').textContent = Math.round(data.velocity).toLocaleString();
          document.getElementById('telVelKms').textContent = (data.velocity / 3600).toFixed(2);
          document.getElementById('statVel').textContent = Math.round(data.velocity);
          
          // Update location name
          this.updateLocationName(lat, lng);
          
          // Increment orbit count
          orbitCount += 0.0001;
          document.getElementById('statOrbit').textContent = Math.floor(orbitCount).toLocaleString();
          document.getElementById('orbitBadge').textContent = 'üõ∞Ô∏è ORBIT ' + Math.floor(orbitCount).toLocaleString();
          
        } catch (error) {
          console.error('Failed to fetch ISS position:', error);
        }
      },
      
      async updateLocationName(lat, lng) {
        try {
          const response = await fetch(`https://api.wheretheiss.at/v1/coordinates/${lat},${lng}`);
          const data = await response.json();
          if (data.timezone_id) {
            const parts = data.timezone_id.split('/');
            const location = parts[parts.length - 1].replace(/_/g, ' ');
            document.getElementById('overLocation').textContent = location;
            document.getElementById('overCountry').textContent = data.country_code || 'Ocean';
          } else {
            document.getElementById('overLocation').textContent = 'Ocean';
            document.getElementById('overCountry').textContent = 'International Waters';
          }
        } catch {
          document.getElementById('overLocation').textContent = lat.toFixed(1) + '¬∞, ' + lng.toFixed(1) + '¬∞';
          document.getElementById('overCountry').textContent = '';
        }
      },
      
      toggleFootprint() {
        this.showFootprint = !this.showFootprint;
        document.getElementById('btnFootprint').classList.toggle('active', this.showFootprint);
        if (this.showFootprint) this.footprintCircle.addTo(this.map);
        else this.footprintCircle.remove();
      },
      
      toggleTrack() {
        this.showTrack = !this.showTrack;
        document.getElementById('btnTrack').classList.toggle('active', this.showTrack);
        if (this.showTrack) this.groundTrack.addTo(this.map);
        else this.groundTrack.remove();
      },
      
      centerOnISS() {
        const pos = this.issMarker.getLatLng();
        this.map.setView(pos, 3, { animate: true });
      }
    };
    
    window.ISSTracker = ISSTracker;

    
    // Update time display
    function updateTime() {
      const now = new Date();
      const utc = now.toISOString().substr(11, 8);
      document.getElementById('utc').textContent = utc + ' UTC';
    }
    
    // NASA Lightstreamer Telemetry
    function initNASATelemetry() {
      try {
        const lsClient = new Ls.LightstreamerClient("https://push.lightstreamer.com", "ISSLIVE");
        lsClient.addListener({
          onStatusChange: function(status) {
            console.log("Lightstreamer status:", status);
          }
        });
        lsClient.connect();
        
        const subscription = new Ls.Subscription("MERGE", TELEMETRY_ITEMS, ["TimeStamp", "Value", "Status"]);
        subscription.setRequestedSnapshot("yes");
        subscription.addListener({
          onItemUpdate: function(update) { handleTelemetryUpdate(update); },
          onSubscription: function() { console.log("NASA telemetry subscription active"); }
        });
        lsClient.subscribe(subscription);
        console.log("NASA Lightstreamer telemetry initialized");
      } catch (error) {
        console.error("Failed to initialize NASA telemetry:", error);
      }
    }
    
    function handleTelemetryUpdate(update) {
      const itemName = update.getItemName();
      const value = update.getValue("Value");
      const status = update.getValue("Status");
      if (value === null || status === "stale") return;
      const numValue = parseFloat(value);
      
      switch(itemName) {
        // Environmental
        case 'USLAB000058':
          nasaTelemetry.cabinPressure = numValue;
          document.getElementById('telPressure').textContent = numValue.toFixed(1) + ' psia';
          break;
        case 'USLAB000059':
          nasaTelemetry.cabinTemp = numValue;
          const tempC = ((numValue - 32) * 5/9).toFixed(1);
          document.getElementById('telTemp').textContent = tempC + '¬∞C';
          break;
        case 'USLAB000053':
          nasaTelemetry.o2Level = numValue;
          document.getElementById('telO2').textContent = numValue.toFixed(1);
          break;
        case 'USLAB000055':
          nasaTelemetry.co2Level = numValue;
          document.getElementById('telCO2').textContent = numValue.toFixed(2);
          break;
          
        // Life Support (Node 3)
        case 'NODE3000010':
          nasaTelemetry.ogsState = numValue;
          const ogsStates = ['OFF', 'STBY', 'PROC', 'SHUTDN'];
          document.getElementById('telOGS').textContent = ogsStates[numValue] || numValue;
          break;
        case 'NODE3000005':
          nasaTelemetry.urineTank = numValue;
          document.getElementById('telUrine').textContent = numValue.toFixed(0) + '%';
          break;
        case 'NODE3000006':
          nasaTelemetry.wpaState = numValue;
          const wpaStates = ['OFF', 'STBY', 'PROC', 'HOT', 'SHUTDN'];
          document.getElementById('telWPA').textContent = wpaStates[numValue] || numValue;
          break;
        case 'NODE3000009':
          nasaTelemetry.cleanWater = numValue;
          document.getElementById('telWater').textContent = numValue.toFixed(0) + '%';
          break;
          
        // Power/Attitude
        case 'USLAB000010':
          nasaTelemetry.cmgMomentum = numValue;
          document.getElementById('telCMG').textContent = numValue.toFixed(0) + '%';
          break;
        case 'USLAB000040':
          nasaTelemetry.betaAngle = numValue;
          document.getElementById('telBeta').textContent = numValue.toFixed(1) + '¬∞';
          break;
        case 'USLAB000039':
          nasaTelemetry.issMass = numValue;
          document.getElementById('telMass').textContent = Math.round(numValue).toLocaleString();
          break;
          
        // Quaternion
        case 'USLAB000018':
          nasaTelemetry.quaternion.w = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000019':
          nasaTelemetry.quaternion.x = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000020':
          nasaTelemetry.quaternion.y = numValue;
          updateAttitudeFromQuaternion();
          break;
        case 'USLAB000021':
          nasaTelemetry.quaternion.z = numValue;
          updateAttitudeFromQuaternion();
          break;
          
        // Solar Array SARJ (Alpha rotation)
        case 'S0000004':
          nasaTelemetry.sarjPort = numValue;
          document.getElementById('telSARJPort').textContent = numValue.toFixed(1) + '¬∞';
          updateSolarArrays();
          break;
        case 'S0000003':
          nasaTelemetry.sarjStbd = numValue;
          document.getElementById('telSARJStbd').textContent = numValue.toFixed(1) + '¬∞';
          updateSolarArrays();
          break;
          
        // Solar Array BGA (Beta gimbal)
        case 'P4000007':
          nasaTelemetry.bgaPort2A = numValue;
          document.getElementById('telBGAPort').textContent = numValue.toFixed(1) + '¬∞';
          updateSolarArrays();
          break;
        case 'P4000008':
          nasaTelemetry.bgaPort4A = numValue;
          updateSolarArrays();
          break;
        case 'S4000007':
          nasaTelemetry.bgaStbd1A = numValue;
          document.getElementById('telBGAStbd').textContent = numValue.toFixed(1) + '¬∞';
          updateSolarArrays();
          break;
        case 'S4000008':
          nasaTelemetry.bgaStbd3A = numValue;
          updateSolarArrays();
          break;
      }
    }
    
    // Solar array joint references (populated after model load)
    // The IGOAL model has dedicated rotation joints for SARJ and BGA
    //
    // *** BUG OPEN (2026-01-26): SARJ rotation causes X-pattern in velocity view ***
    // ISS Solar Array Rotation System
    // Port and starboard SARJ operate independently - X-pattern is normal when values differ
    // See: docs/ISS-SOLAR-ARRAY-JOINTS-STATUS.md for details
    //
    let solarJoints = { nadir: {}, velocity: {} };
    
    // Find solar array rotation joints in the model
    // NASA ISS Stationary model node names:
    // SARJ: 20_P4_Truss (port), 23_S4_Truss (starboard) - X-axis rotation
    // BGA: *_Truss_01, *_Truss_02 for each wing pair - Z-axis rotation
    function findSolarArrayJoints(model, viewName) {
      const joints = {
        portSARJ: null,   // 20_P4_Truss - rotates around X axis
        stbdSARJ: null,   // 23_S4_Truss - rotates around X axis
        portBGA: [],      // P4 and P6 wings - rotate around Z axis
        stbdBGA: []       // S4 and S6 wings - rotate around Z axis
      };
      
      model.traverse(child => {
        if (!child.name) return;
        
        // SARJ joints (X-axis rotation for paddlewheel motion)
        if (child.name === '20_P4_Truss') joints.portSARJ = child;
        if (child.name === '23_S4_Truss') joints.stbdSARJ = child;
        
        // BGA joints (Z-axis rotation for propeller spin)
        // Port side: P4 and P6 wings
        if (child.name === '20_P4_Truss_01') joints.portBGA.push({ node: child, id: '4B' });
        if (child.name === '20_P4_Truss_02') joints.portBGA.push({ node: child, id: '2B' });
        if (child.name === '08_P6_Truss_01') joints.portBGA.push({ node: child, id: '4A' });
        if (child.name === '08_P6_Truss_02') joints.portBGA.push({ node: child, id: '2A' });
        
        // Starboard side: S4 and S6 wings
        if (child.name === '23_S4_Truss_01') joints.stbdBGA.push({ node: child, id: '3B' });
        if (child.name === '23_S4_Truss_02') joints.stbdBGA.push({ node: child, id: '1B' });
        if (child.name === '32_S6_Truss_01') joints.stbdBGA.push({ node: child, id: '3A' });
        if (child.name === '32_S6_Truss_02') joints.stbdBGA.push({ node: child, id: '1A' });
      });
      
      solarJoints[viewName] = joints;
      console.log(`Found joints in ${viewName}: SARJ(port:${!!joints.portSARJ}, stbd:${!!joints.stbdSARJ}), BGA(port:${joints.portBGA.length}, stbd:${joints.stbdBGA.length})`);
    }
    
    // Update solar array rotations based on telemetry
    // NASA ISS Stationary model:
    // SARJ: X-axis rotation (paddlewheel around truss)
    // BGA: Z-axis rotation (propeller spin around boom)
    // Note: _02 wings are geometrically mirrored, so rotation must be negated
    function updateSolarArrays() {
      if (!issModelNadir || !issModelVelocity) return;
      
      // Convert telemetry angles to radians
      // SARJ rotates entire outboard section around truss axis (X)
      // BGA rotates individual wings around boom axis (Z)
      const sarjPortRad = (nasaTelemetry.sarjPort || 0) * Math.PI / 180;
      const sarjStbdRad = (nasaTelemetry.sarjStbd || 0) * Math.PI / 180;
      
      // BGA angles for each array wing
      const bgaPort2A = (nasaTelemetry.bgaPort2A || 0) * Math.PI / 180;
      const bgaPort4A = (nasaTelemetry.bgaPort4A || 0) * Math.PI / 180;
      const bgaStbd1A = (nasaTelemetry.bgaStbd1A || 0) * Math.PI / 180;
      const bgaStbd3A = (nasaTelemetry.bgaStbd3A || 0) * Math.PI / 180;
      
      // Apply rotations to both views
      ['nadir', 'velocity'].forEach(viewName => {
        const joints = solarJoints[viewName];
        if (!joints) return;
        
        // SARJ rotation: X-axis (paddlewheel motion around truss)
        if (joints.portSARJ) joints.portSARJ.rotation.x = sarjPortRad;
        if (joints.stbdSARJ) joints.stbdSARJ.rotation.x = sarjStbdRad;
        
        // BGA rotation: Z-axis (propeller spin around boom)
        // _02 wings are mirrored geometry, so negate their rotation
        joints.portBGA.forEach(joint => {
          const id = joint.id;
          const isWing02 = joint.node.name.endsWith('_02');
          const sign = isWing02 ? -1 : 1;
          
          if (id === '2A' || id === '2B') {
            joint.node.rotation.z = sign * bgaPort2A;
          } else if (id === '4A' || id === '4B') {
            joint.node.rotation.z = sign * bgaPort4A;
          }
        });
        
        joints.stbdBGA.forEach(joint => {
          const id = joint.id;
          const isWing02 = joint.node.name.endsWith('_02');
          const sign = isWing02 ? -1 : 1;
          
          if (id === '1A' || id === '1B') {
            joint.node.rotation.z = sign * bgaStbd1A;
          } else if (id === '3A' || id === '3B') {
            joint.node.rotation.z = sign * bgaStbd3A;
          }
        });
      });
    }
    
    // Legacy mesh references for compatibility
    let solarArrayMeshes = { nadir: {}, velocity: {} };
    
    function quaternionToEuler(q) {
      const sinr_cosp = 2 * (q.w * q.x + q.y * q.z);
      const cosr_cosp = 1 - 2 * (q.x * q.x + q.y * q.y);
      const roll = Math.atan2(sinr_cosp, cosr_cosp) * (180 / Math.PI);
      const sinp = 2 * (q.w * q.y - q.z * q.x);
      let pitch = Math.abs(sinp) >= 1 ? Math.sign(sinp) * 90 : Math.asin(sinp) * (180 / Math.PI);
      const siny_cosp = 2 * (q.w * q.z + q.x * q.y);
      const cosy_cosp = 1 - 2 * (q.y * q.y + q.z * q.z);
      const yaw = Math.atan2(siny_cosp, cosy_cosp) * (180 / Math.PI);
      return { roll, pitch, yaw };
    }
    
    function updateAttitudeFromQuaternion() {
      const q = nasaTelemetry.quaternion;
      const magnitude = Math.sqrt(q.w*q.w + q.x*q.x + q.y*q.y + q.z*q.z);
      if (magnitude < 0.9 || magnitude > 1.1) return;
      
      const euler = quaternionToEuler(q);
      
      if (window.THREE) {
        if (!targetQuaternion) targetQuaternion = new window.THREE.Quaternion();
        targetQuaternion.set(q.x, q.y, q.z, q.w);
        targetQuaternion.normalize();
      }
      
      targetAttitude = euler;
      
      // Update quaternion display
      document.getElementById('quatQ0').textContent = q.w.toFixed(4);
      document.getElementById('quatQ1').textContent = q.x.toFixed(4);
      document.getElementById('quatQ2').textContent = q.y.toFixed(4);
      document.getElementById('quatQ3').textContent = q.z.toFixed(4);
      
      // Update Euler angles
      document.getElementById('telRoll').textContent = euler.roll.toFixed(2) + '¬∞';
      document.getElementById('telPitch').textContent = euler.pitch.toFixed(2) + '¬∞';
      document.getElementById('telYaw').textContent = euler.yaw.toFixed(2) + '¬∞';
    }

    
    // Dual 3D View System
    async function initDual3DISS() {
      const THREE = await import('three');
      const { GLTFLoader } = await import('three/addons/loaders/GLTFLoader.js');
      const { DRACOLoader } = await import('three/addons/loaders/DRACOLoader.js');
      
      window.THREE = THREE;
      
      setupDualView('nadir', THREE);
      setupDualView('velocity', THREE);
      await loadDualISSModel(THREE, GLTFLoader, DRACOLoader);
      animateDual3D();
      window.addEventListener('resize', onDualResize);
    }
    
    function setupDualView(viewName, THREE) {
      const canvas = document.getElementById(viewName + 'Canvas');
      const container = document.getElementById(viewName + 'View');
      if (!canvas || !container) return;
      
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);
      
      const aspect = container.clientWidth / container.clientHeight;
      const frustumSize = 80;
      const camera = new THREE.OrthographicCamera(
        -frustumSize * aspect / 2, frustumSize * aspect / 2,
        frustumSize / 2, -frustumSize / 2, 0.1, 1000
      );
      
      if (viewName === 'nadir') {
        camera.position.set(0, -100, 0);
        camera.up.set(1, 0, 0);
        camera.lookAt(0, 0, 0);
      } else {
        camera.position.set(100, 0, 0);
        camera.up.set(0, -1, 0);
        camera.lookAt(0, 0, 0);
      }
      
      const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      
      // Brighter ambient light for visibility
      const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
      scene.add(ambientLight);
      
      // Main directional light (sun-like)
      const directionalLight = new THREE.DirectionalLight(0xffffff, 2.0);
      directionalLight.position.set(50, 30, 50);
      scene.add(directionalLight);
      
      // Fill light from opposite side
      const fillLight = new THREE.DirectionalLight(0x88aaff, 1.0);
      fillLight.position.set(-50, -20, -30);
      scene.add(fillLight);
      
      // Top light for solar panels visibility
      const topLight = new THREE.DirectionalLight(0xffffee, 1.5);
      topLight.position.set(0, 100, 0);
      scene.add(topLight);
      
      if (viewName === 'nadir') {
        nadirScene = scene; nadirCamera = camera; nadirRenderer = renderer;
      } else {
        velocityScene = scene; velocityCamera = camera; velocityRenderer = renderer;
      }
    }
    
    async function loadDualISSModel(THREE, GLTFLoader, DRACOLoader) {
      const dracoLoader = new DRACOLoader();
      dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/gltf/');
      const loader = new GLTFLoader();
      loader.setDRACOLoader(dracoLoader);
      
      return new Promise((resolve, reject) => {
        loader.load('../assets/iss-stationary.glb',
          (gltf) => {
            const model = gltf.scene;
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            model.position.sub(center);
            const maxDim = Math.max(size.x, size.y, size.z);
            model.scale.setScalar(50 / maxDim);
            
            issModelNadir = model;
            issModelVelocity = model.clone();
            
            // Find solar array rotation joints (SARJ and BGA)
            findSolarArrayJoints(issModelNadir, 'nadir');
            findSolarArrayJoints(issModelVelocity, 'velocity');
            
            // Also find mesh references for legacy compatibility
            findSolarArrayMeshes(issModelNadir, 'nadir');
            findSolarArrayMeshes(issModelVelocity, 'velocity');
            
            // Log found mesh names for debugging
            console.log('ISS Model meshes:');
            model.traverse(child => {
              if (child.isMesh) console.log('  -', child.name);
            });
            
            if (nadirScene) nadirScene.add(issModelNadir);
            if (velocityScene) velocityScene.add(issModelVelocity);
            
            document.getElementById('nadirLoading')?.classList.add('hidden');
            document.getElementById('velocityLoading')?.classList.add('hidden');
            resolve();
          },
          (progress) => {
            if (progress.total > 0) {
              const pct = Math.round((progress.loaded / progress.total) * 100);
              document.getElementById('nadirProgress')?.textContent && (document.getElementById('nadirProgress').textContent = pct + '%');
              document.getElementById('velocityProgress')?.textContent && (document.getElementById('velocityProgress').textContent = pct + '%');
            }
          },
          (error) => { console.error('Error loading ISS model:', error); reject(error); }
        );
      });
    }
    
    // Find solar array meshes in the model by name patterns
    function findSolarArrayMeshes(model, viewName) {
      const portArrays = [];
      const stbdArrays = [];
      
      model.traverse(child => {
        if (!child.isMesh && !child.isGroup) return;
        const name = (child.name || '').toLowerCase();
        
        // Common naming patterns for solar arrays
        // Port side: P1, P3, P4, P6, port, left, 2A, 4A, 2B, 4B
        // Starboard side: S1, S3, S4, S6, stbd, starboard, right, 1A, 3A, 1B, 3B
        if (name.includes('solar') || name.includes('array') || name.includes('panel') || name.includes('wing')) {
          if (name.includes('port') || name.includes('left') || name.includes('p1') || 
              name.includes('p3') || name.includes('p4') || name.includes('p6') ||
              name.includes('2a') || name.includes('4a') || name.includes('2b') || name.includes('4b')) {
            portArrays.push(child);
          } else if (name.includes('stbd') || name.includes('starboard') || name.includes('right') || 
                     name.includes('s1') || name.includes('s3') || name.includes('s4') || name.includes('s6') ||
                     name.includes('1a') || name.includes('3a') || name.includes('1b') || name.includes('3b')) {
            stbdArrays.push(child);
          }
        }
      });
      
      solarArrayMeshes[viewName] = { portArrays, stbdArrays };
      console.log(`Found ${portArrays.length} port arrays, ${stbdArrays.length} stbd arrays in ${viewName} view`);
    }
    
    function animateDual3D() {
      requestAnimationFrame(animateDual3D);
      
      if (issModelNadir && issModelVelocity && window.THREE && targetQuaternion) {
        if (!currentQuaternion) currentQuaternion = targetQuaternion.clone();
        currentQuaternion.slerp(targetQuaternion, 0.05);
        issModelNadir.quaternion.copy(currentQuaternion);
        issModelVelocity.quaternion.copy(currentQuaternion);
      }
      
      if (nadirRenderer && nadirScene && nadirCamera) nadirRenderer.render(nadirScene, nadirCamera);
      if (velocityRenderer && velocityScene && velocityCamera) velocityRenderer.render(velocityScene, velocityCamera);
    }
    
    function onDualResize() {
      const frustumSize = 80;
      ['nadir', 'velocity'].forEach(viewName => {
        const container = document.getElementById(viewName + 'View');
        const camera = viewName === 'nadir' ? nadirCamera : velocityCamera;
        const renderer = viewName === 'nadir' ? nadirRenderer : velocityRenderer;
        if (camera && renderer && container) {
          const aspect = container.clientWidth / container.clientHeight;
          camera.left = -frustumSize * aspect / 2;
          camera.right = frustumSize * aspect / 2;
          camera.top = frustumSize / 2;
          camera.bottom = -frustumSize / 2;
          camera.updateProjectionMatrix();
          renderer.setSize(container.clientWidth, container.clientHeight);
        }
      });
    }
    
    // Expose key objects for testing/debugging
    window.nasaTelemetry = nasaTelemetry;
    window.updateSolarArrays = updateSolarArrays;
    window.solarArrayMeshes = solarArrayMeshes;
    window.solarJoints = solarJoints;
    window.ISSTracker = ISSTracker;
    window.getISSModels = () => ({ nadir: issModelNadir, velocity: issModelVelocity });
    
    // === News Ticker ===
    async function fetchISSNews() {
      try {
        // Try local API first, then fallback to different ports
        let response;
        const urls = ['/api/iss/news?limit=8', 'http://localhost:8000/api/iss/news?limit=8', 'http://localhost:8001/api/iss/news?limit=8'];
        
        for (const url of urls) {
          try {
            response = await fetch(url);
            if (response.ok) break;
          } catch { continue; }
        }
        
        if (!response || !response.ok) throw new Error('News fetch failed');
        const data = await response.json();
        
        const tickerContent = document.getElementById('tickerContent');
        if (!tickerContent || !data.news || data.news.length === 0) return;
        
        // Build ticker HTML
        let html = '';
        // Duplicate for seamless scroll
        for (let i = 0; i < 2; i++) {
          html += '<div class="ticker-label">ISS UPDATE</div>';
          data.news.forEach(item => {
            const time = item.time_ago || '';
            const title = item.title || 'ISS News';
            html += `<div class="ticker-item"><span class="ticker-time">${time}</span>${title}</div>`;
          });
        }
        
        tickerContent.innerHTML = html;
        console.log(`Loaded ${data.news.length} ISS news items`);
      } catch (err) {
        console.warn('Failed to fetch ISS news:', err);
        // Keep placeholder text on error
      }
    }
    
    // Initialize everything
    document.addEventListener('DOMContentLoaded', () => {
      ISSTracker.init();
      initDual3DISS();
      initNASATelemetry();
      updateTime();
      setInterval(updateTime, 1000);
      
      // Fetch news on load and refresh every 15 minutes
      fetchISSNews();
      setInterval(fetchISSNews, 15 * 60 * 1000);
    });
  </script>
</body>
</html>
